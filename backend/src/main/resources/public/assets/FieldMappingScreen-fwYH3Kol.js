import{j as e}from"./ui-vendor-B4gDKxp2.js";import{r as g,R as Ye}from"./react-vendor-pDgKdaAw.js";import{w as ke,v as O,a9 as nt,aa as ot,B as ne,G as it,S as we,h as Ce,i as Se,j as Fe,k as Q,g as ae,I as ie,m as De,A as Te,d as Ee,l as u,L as m,x as qt,a8 as ce,c as Ne,a6 as et,al as ct,o as Ie,p as Re,q as Ae,s as Ge,r as Le,ap as tt,F as lt,e as at,a as dt,t as kt}from"./index-BgQC9CM8.js";import{u as ut}from"./useDataStructures-Pt_GHR_1.js";import{D as pe,a as Mt,b as he,c as xe,d as ge,e as $t}from"./dialog-Y0RrrX5c.js";import{S as Pe}from"./search-JfXMCu6I.js";import{u as He,H as le,P as de,g as It,B as Rt,E as At,a as Lt,b as Pt,M as be,c as st,i as Ut,C as Ot,d as _t,e as Gt,f as Xt,h as rt}from"./editor-vendor-CjSHClq6.js";import{D as Xe}from"./database-N39ckc6O.js";import{T as Ve}from"./textarea-BHEIvuLF.js";import{Z as qe}from"./zap-CM85Vbc2.js";import{S as mt}from"./scroll-area-C-DwBH_w.js";import{T as pt,a as ht,b as ze,c as Be}from"./tabs-CYHCjqpK.js";import{S as Vt}from"./save-ByutG-nw.js";import{P as zt}from"./plus-DX1aRrf7.js";import{U as Bt}from"./upload-DrPqjWDa.js";import{C as Wt}from"./copy-DLp_ORz7.js";import{D as Yt}from"./download-BfMNLWCh.js";import{P as xt}from"./play-BtGvvKDg.js";import{T as Ht}from"./trash-2-BpPlwinj.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Oe=ke("Calculator",[["rect",{width:"16",height:"20",x:"4",y:"2",rx:"2",key:"1nb95v"}],["line",{x1:"8",x2:"16",y1:"6",y2:"6",key:"x4nwl0"}],["line",{x1:"16",x2:"16",y1:"14",y2:"18",key:"wjye3r"}],["path",{d:"M16 10h.01",key:"1m94wz"}],["path",{d:"M12 10h.01",key:"1nrarc"}],["path",{d:"M8 10h.01",key:"19clt8"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M8 14h.01",key:"6423bh"}],["path",{d:"M12 18h.01",key:"mhygvu"}],["path",{d:"M8 18h.01",key:"lrp35t"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Jt=ke("GitBranch",[["line",{x1:"6",x2:"6",y1:"3",y2:"15",key:"17qcm7"}],["circle",{cx:"18",cy:"6",r:"3",key:"1h7g24"}],["circle",{cx:"6",cy:"18",r:"3",key:"fqmcym"}],["path",{d:"M18 9a9 9 0 0 1-9 9",key:"n2h4wq"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Zt=ke("Hash",[["line",{x1:"4",x2:"20",y1:"9",y2:"9",key:"4lhtct"}],["line",{x1:"4",x2:"20",y1:"15",y2:"15",key:"vyu0kd"}],["line",{x1:"10",x2:"8",y1:"3",y2:"21",key:"1ggp8o"}],["line",{x1:"16",x2:"14",y1:"3",y2:"21",key:"weycgp"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Kt=ke("Link2",[["path",{d:"M9 17H7A5 5 0 0 1 7 7h2",key:"8i5ue5"}],["path",{d:"M15 7h2a5 5 0 1 1 0 10h-2",key:"1b9ql8"}],["line",{x1:"8",x2:"16",y1:"12",y2:"12",key:"1jonct"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Qt=ke("Target",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["circle",{cx:"12",cy:"12",r:"6",key:"1vlfrh"}],["circle",{cx:"12",cy:"12",r:"2",key:"1c9p78"}]]);function gt({fields:t,mappings:s,side:n,selectedField:a,onToggleExpanded:r,onDragStart:o,onDragEnd:l,onDragOver:p,onDrop:x,onSelectField:j}){const S=g.useCallback((N,C)=>{const c=!N.children||N.children.length===0,f=N.type==="array"||N.name.endsWith("[]"),b=!c&&(f||N.type==="object"),i=n==="source"&&(c||b),F=n==="target"&&(c||b),T=s.some(y=>{if(n==="source"){const E=y.sourcePaths&&y.sourcePaths.includes(N.path),P=y.sourceFields&&y.sourceFields.includes(N.name);return E||P}else return y.targetPath===N.path||y.targetField===N.name}),h=a?.id===N.id;return e.jsxs("div",{className:"w-full",children:[e.jsxs("div",{className:`flex items-center p-2 border rounded-md transition-colors ${h?"bg-primary/20 border-primary ring-1 ring-primary":T?"bg-primary/10 border-primary border-dotted border-2":"bg-background hover:bg-muted/50"} ${i?"cursor-grab active:cursor-grabbing":""} ${F&&!T?"border-dashed border-2 hover:border-primary cursor-pointer":""}`,style:{marginLeft:`${C*16}px`},draggable:i,onClick:()=>{j&&j(N)},onDragStart:y=>{i&&o&&(y.dataTransfer.effectAllowed="copy",y.dataTransfer.setData("application/json",JSON.stringify(N)),o(N))},onDragEnd:y=>{i&&l&&l()},onDragOver:F?p:void 0,onDrop:y=>{F&&(y.preventDefault(),y.stopPropagation(),x?.(N))},children:[!c&&e.jsx(O,{variant:"ghost",size:"sm",onClick:()=>r(N.id,n==="source"),className:"mr-2 h-auto w-auto p-1 hover:bg-muted rounded",children:N.expanded?e.jsx(nt,{className:"h-3 w-3"}):e.jsx(ot,{className:"h-3 w-3"})}),e.jsxs("div",{className:"flex-1 flex items-center gap-2",children:[e.jsx("span",{className:"font-medium text-sm",children:N.name}),e.jsx(ne,{variant:"outline",className:"text-xs",children:N.type}),T&&e.jsx(Kt,{className:"h-3 w-3 text-primary"}),b&&e.jsx(ne,{variant:"secondary",className:"text-xs",children:"Node"})]}),n==="source"&&i&&e.jsx("span",{className:"text-xs text-muted-foreground",children:"Drag →"}),n==="target"&&F&&e.jsx("span",{className:"text-xs text-muted-foreground",children:"Drop here"})]}),!c&&N.expanded&&N.children&&e.jsx("div",{className:"ml-4",children:N.children.map(y=>S(y,C+1))})]},N.id)},[s,n,a,r,o,l,p,x,j]);return e.jsx("div",{className:"space-y-2",children:t.map(N=>S(N,0))})}function ft({isOpen:t,onOpenChange:s,selectedService:n,onSelectService:a,title:r,usage:o,businessComponentId:l}){const{structures:p}=ut(),x=p.filter(j=>{const S=j.usage===o,N=!l||j.businessComponentId===l;return S&&N});return e.jsxs(pe,{open:t,onOpenChange:s,children:[e.jsx(Mt,{asChild:!0,children:e.jsxs(O,{variant:"outline",size:"sm",children:[e.jsx(it,{className:"h-4 w-4 mr-2"}),"Select"]})}),e.jsxs(he,{className:"max-w-2xl",children:[e.jsx(xe,{children:e.jsx(ge,{children:r})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Select Data Structure"}),e.jsxs(we,{onValueChange:a,value:n,children:[e.jsx(Ce,{className:"w-full",children:e.jsx(Se,{placeholder:"Choose a data structure..."})}),e.jsx(Fe,{className:"bg-background border shadow-lg z-50",children:x.map(j=>e.jsx(Q,{value:j.name,children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"font-medium",children:j.name}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:[j.type.toUpperCase()," • ",j.description||"No description"]})]})},j.id))})]})]}),x.length===0&&e.jsx("div",{className:"border rounded-md p-3 space-y-2",children:e.jsxs("div",{className:"text-sm text-muted-foreground",children:["No data structures found for ",o," usage. Please create data structures on the Data Structures page first."]})}),n&&e.jsxs("div",{className:"border rounded-md p-3 space-y-2 bg-muted/20",children:[e.jsx("div",{className:"text-sm font-medium",children:"Selected Structure"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:x.find(j=>j.name===n)?.description||n})]})]})]})]})}function ea({fields:t,mappings:s,selectedService:n,searchValue:a,showSelector:r,selectedField:o,onSearchChange:l,onShowSelectorChange:p,onSelectService:x,onToggleExpanded:j,onDragStart:S,onDragEnd:N,onSelectField:C,isLoading:c=!1,hideSelector:f=!1}){return e.jsxs("div",{className:"w-1/3 border-r bg-muted/20 animate-fade-in",children:[e.jsxs("div",{className:"p-4 border-b bg-background",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx(ae,{className:"font-semibold",children:"Source Message"}),";",!f&&e.jsx(ft,{isOpen:r,onOpenChange:p,selectedService:n,onSelectService:x,title:"Select Source Message",usage:"source"})]}),e.jsx("div",{className:"text-sm text-muted-foreground mb-3 p-2 bg-background border rounded",children:n||"No source selected"}),e.jsxs("div",{className:"relative",children:[e.jsx(Pe,{className:"h-4 w-4 absolute left-3 top-3 text-muted-foreground"}),e.jsx(ie,{placeholder:"Search source fields...",value:a,onChange:b=>l(b.target.value),className:"pl-10"})]})]}),e.jsx("div",{className:"p-4 h-[calc(100%-140px)] overflow-y-auto",children:c?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"text-center space-y-3",children:[e.jsx(De,{className:"h-8 w-8 animate-spin mx-auto text-muted-foreground"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Converting structure to XML..."})]})}):t.length===0?e.jsx(Te,{children:e.jsx(Ee,{children:"Select a source data structure to view fields"})}):e.jsx(gt,{fields:t,mappings:s,side:"source",selectedField:o,onToggleExpanded:j,onDragStart:S,onDragEnd:N,onSelectField:C})})]})}function ta({fields:t,mappings:s,selectedService:n,searchValue:a,showSelector:r,selectedField:o,onSearchChange:l,onShowSelectorChange:p,onSelectService:x,onToggleExpanded:j,onDragOver:S,onDrop:N,onSelectField:C,isLoading:c=!1,hideSelector:f=!1}){return e.jsxs("div",{className:"w-1/3 border-l bg-muted/20 animate-fade-in",children:[e.jsxs("div",{className:"p-4 border-b bg-background",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx(ae,{className:"font-semibold",children:"Target Message"}),";",!f&&e.jsx(ft,{isOpen:r,onOpenChange:p,selectedService:n,onSelectService:x,title:"Select Target Message",usage:"target"})]}),e.jsx("div",{className:"text-sm text-muted-foreground mb-3 p-2 bg-background border rounded",children:n||"No target selected"}),e.jsxs("div",{className:"relative",children:[e.jsx(Pe,{className:"h-4 w-4 absolute left-3 top-3 text-muted-foreground"}),e.jsx(ie,{placeholder:"Search target fields...",value:a,onChange:b=>l(b.target.value),className:"pl-10"})]})]}),e.jsx("div",{className:"p-4 h-[calc(100%-140px)] overflow-y-auto",children:c?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"text-center space-y-3",children:[e.jsx(De,{className:"h-8 w-8 animate-spin mx-auto text-muted-foreground"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Converting structure to XML..."})]})}):t.length===0?e.jsx(Te,{children:e.jsx(Ee,{children:"Select a target data structure to view fields"})}):e.jsx(gt,{fields:t,mappings:s,side:"target",selectedField:o,onToggleExpanded:j,onDragOver:S,onDrop:N,onSelectField:C})})]})}const aa=[{name:"add",category:"math",description:"Add two numbers",parameters:[{name:"a",type:"number",required:!0,description:"First number"},{name:"b",type:"number",required:!0,description:"Second number"}],execute:(t,s)=>t+s,javaTemplate:"add({0}, {1})"},{name:"subtract",category:"math",description:"Subtract two numbers",parameters:[{name:"a",type:"number",required:!0,description:"First number"},{name:"b",type:"number",required:!0,description:"Second number"}],execute:(t,s)=>t-s,javaTemplate:"subtract({0}, {1})"},{name:"multiply",category:"math",description:"Multiply two numbers",parameters:[{name:"a",type:"number",required:!0},{name:"b",type:"number",required:!0}],execute:(t,s)=>t*s,javaTemplate:"multiply({0}, {1})"},{name:"divide",category:"math",description:"Divide two numbers",parameters:[{name:"a",type:"number",required:!0},{name:"b",type:"number",required:!0}],execute:(t,s)=>t/s,javaTemplate:"divide({0}, {1})"},{name:"equals",category:"math",description:"Check if two numbers are equal",parameters:[{name:"a",type:"number",required:!0},{name:"b",type:"number",required:!0}],execute:(t,s)=>t===s,javaTemplate:"equals({0}, {1})"},{name:"absolute",category:"math",description:"Get absolute value of a number",parameters:[{name:"value",type:"number",required:!0}],execute:t=>Math.abs(t),javaTemplate:"absolute({0})"},{name:"sqrt",category:"math",description:"Get square root of a number",parameters:[{name:"value",type:"number",required:!0}],execute:t=>Math.sqrt(t),javaTemplate:"sqrt({0})"},{name:"square",category:"math",description:"Square a number",parameters:[{name:"value",type:"number",required:!0}],execute:t=>t*t,javaTemplate:"square({0})"},{name:"sign",category:"math",description:"Get sign of a number (-1, 0, or 1)",parameters:[{name:"value",type:"number",required:!0}],execute:t=>Math.sign(t),javaTemplate:"sign({0})"},{name:"neg",category:"math",description:"Negate a number",parameters:[{name:"value",type:"number",required:!0}],execute:t=>-t,javaTemplate:"neg({0})"},{name:"inv",category:"math",description:"Get inverse of a number (1/x)",parameters:[{name:"value",type:"number",required:!0}],execute:t=>1/t,javaTemplate:"inv({0})"},{name:"power",category:"math",description:"Raise number to power",parameters:[{name:"base",type:"number",required:!0},{name:"exponent",type:"number",required:!0}],execute:(t,s)=>Math.pow(t,s),javaTemplate:"power({0}, {1})"},{name:"lesser",category:"math",description:"Check if first number is less than second",parameters:[{name:"a",type:"number",required:!0},{name:"b",type:"number",required:!0}],execute:(t,s)=>t<s,javaTemplate:"lesser({0}, {1})"},{name:"greater",category:"math",description:"Check if first number is greater than second",parameters:[{name:"a",type:"number",required:!0},{name:"b",type:"number",required:!0}],execute:(t,s)=>t>s,javaTemplate:"greater({0}, {1})"},{name:"max",category:"math",description:"Get maximum of two numbers",parameters:[{name:"a",type:"number",required:!0},{name:"b",type:"number",required:!0}],execute:(t,s)=>Math.max(t,s),javaTemplate:"max({0}, {1})"},{name:"min",category:"math",description:"Get minimum of two numbers",parameters:[{name:"a",type:"number",required:!0},{name:"b",type:"number",required:!0}],execute:(t,s)=>Math.min(t,s),javaTemplate:"min({0}, {1})"},{name:"ceil",category:"math",description:"Round number up to nearest integer",parameters:[{name:"value",type:"number",required:!0}],execute:t=>Math.ceil(t),javaTemplate:"ceil({0})"},{name:"floor",category:"math",description:"Round number down to nearest integer",parameters:[{name:"value",type:"number",required:!0}],execute:t=>Math.floor(t),javaTemplate:"floor({0})"},{name:"round",category:"math",description:"Round number to nearest integer",parameters:[{name:"value",type:"number",required:!0}],execute:t=>Math.round(t),javaTemplate:"round({0})"},{name:"counter",category:"math",description:"Generate incremental counter",parameters:[{name:"start",type:"number",required:!1,description:"Starting value"},{name:"step",type:"number",required:!1,description:"Increment step"}],execute:(t=1,s=1)=>t+s,javaTemplate:"counter({0}, {1})"},{name:"formatNumber",category:"math",description:"Format number with specified total digits and decimal places",parameters:[{name:"value",type:"number",required:!0,description:"Number to format"},{name:"totalDigits",type:"number",required:!0,description:"Total number of digits required (adds trailing zeros)"},{name:"decimals",type:"number",required:!1,description:"Number of decimal places"}],execute:(t,s,n=2)=>Number(t.toFixed(n)).toString().padStart(s,"0"),javaTemplate:"formatNumber({0}, {1}, {2})"},{name:"sum",category:"math",description:"Sum multiple numbers",parameters:[{name:"values",type:"array",required:!0,description:"Array of numbers to sum"}],execute:t=>t.reduce((s,n)=>s+n,0),javaTemplate:"sum({0})"},{name:"average",category:"math",description:"Calculate average of numbers",parameters:[{name:"values",type:"array",required:!0,description:"Array of numbers"}],execute:t=>t.reduce((s,n)=>s+n,0)/t.length,javaTemplate:"average({0})"},{name:"count",category:"math",description:"Count elements in array",parameters:[{name:"values",type:"array",required:!0,description:"Array to count"}],execute:t=>t.length,javaTemplate:"count({0})"},{name:"index",category:"math",description:"Get current index in iteration",parameters:[{name:"position",type:"number",required:!0,description:"Current position"}],execute:t=>t,javaTemplate:"index({0})"}],sa=[{name:"concat",category:"text",description:"Concatenate two strings with optional delimiter",parameters:[{name:"string1",type:"string",required:!0,description:"First string to concatenate"},{name:"string2",type:"string",required:!0,description:"Second string to concatenate"},{name:"delimiter",type:"string",required:!1,description:"Optional delimiter between strings"}],execute:(t,s,n)=>n?t+n+s:t+s,javaTemplate:"concat({0}, {1}, {2})"},{name:"substring",category:"text",description:"Extract substring from text",parameters:[{name:"text",type:"string",required:!0},{name:"start",type:"number",required:!0},{name:"end",type:"number",required:!1}],execute:(t,s,n)=>t.substring(s,n),javaTemplate:"substring({0}, {1}, {2})"},{name:"equals",category:"text",description:"Check if two strings are equal",parameters:[{name:"string1",type:"string",required:!0},{name:"string2",type:"string",required:!0}],execute:(t,s)=>t===s,javaTemplate:"equals({0}, {1})"},{name:"indexOf",category:"text",description:"Find index of substring",parameters:[{name:"text",type:"string",required:!0},{name:"searchValue",type:"string",required:!0}],execute:(t,s)=>t.indexOf(s),javaTemplate:"indexOf({0}, {1})"},{name:"lastIndexOf",category:"text",description:"Find last index of substring",parameters:[{name:"text",type:"string",required:!0},{name:"searchValue",type:"string",required:!0}],execute:(t,s)=>t.lastIndexOf(s),javaTemplate:"lastIndexOf({0}, {1})"},{name:"compare",category:"text",description:"Compare two strings lexicographically",parameters:[{name:"string1",type:"string",required:!0},{name:"string2",type:"string",required:!0}],execute:(t,s)=>t.localeCompare(s),javaTemplate:"compare({0}, {1})"},{name:"replaceString",category:"text",description:"Replace substring in text",parameters:[{name:"text",type:"string",required:!0},{name:"searchValue",type:"string",required:!0},{name:"replaceValue",type:"string",required:!0}],execute:(t,s,n)=>t.replace(s,n),javaTemplate:"replaceString({0}, {1}, {2})"},{name:"length",category:"text",description:"Get length of string",parameters:[{name:"text",type:"string",required:!0}],execute:t=>t.length,javaTemplate:"length({0})"},{name:"endsWith",category:"text",description:"Check if string ends with specified suffix",parameters:[{name:"text",type:"string",required:!0},{name:"suffix",type:"string",required:!0}],execute:(t,s)=>t.endsWith(s),javaTemplate:"endsWith({0}, {1})"},{name:"startsWith",category:"text",description:"Check if string starts with specified prefix",parameters:[{name:"text",type:"string",required:!0},{name:"prefix",type:"string",required:!0}],execute:(t,s)=>t.startsWith(s),javaTemplate:"startsWith({0}, {1})"},{name:"toUpperCase",category:"text",description:"Convert text to uppercase",parameters:[{name:"text",type:"string",required:!0}],execute:t=>t.toUpperCase(),javaTemplate:"toUpperCase({0})"},{name:"toLowerCase",category:"text",description:"Convert text to lowercase",parameters:[{name:"text",type:"string",required:!0}],execute:t=>t.toLowerCase(),javaTemplate:"toLowerCase({0})"},{name:"trim",category:"text",description:"Remove whitespace from both ends",parameters:[{name:"text",type:"string",required:!0}],execute:t=>t.trim(),javaTemplate:"trim({0})"}],ra=[{name:"and",category:"boolean",description:"Logical AND operation",parameters:[{name:"a",type:"boolean",required:!0},{name:"b",type:"boolean",required:!0}],execute:(t,s)=>t&&s,javaTemplate:"and({0}, {1})"},{name:"or",category:"boolean",description:"Logical OR operation",parameters:[{name:"a",type:"boolean",required:!0},{name:"b",type:"boolean",required:!0}],execute:(t,s)=>t||s,javaTemplate:"or({0}, {1})"},{name:"not",category:"boolean",description:"Logical NOT operation",parameters:[{name:"value",type:"boolean",required:!0}],execute:t=>!t,javaTemplate:"not({0})"},{name:"equals",category:"boolean",description:"Check if two boolean values are equal",parameters:[{name:"a",type:"boolean",required:!0},{name:"b",type:"boolean",required:!0}],execute:(t,s)=>t===s,javaTemplate:"equals({0}, {1})"},{name:"notEquals",category:"boolean",description:"Check if two values are not equal",parameters:[{name:"a",type:"string",required:!0},{name:"b",type:"string",required:!0}],execute:(t,s)=>t!==s,javaTemplate:"notEquals({0}, {1})"},{name:"if",category:"boolean",description:"Conditional logic with true/false branches",parameters:[{name:"condition",type:"boolean",required:!0},{name:"trueValue",type:"string",required:!0},{name:"falseValue",type:"string",required:!0}],execute:(t,s,n)=>t?s:n,javaTemplate:"if({0}, {1}, {2})"},{name:"ifWithoutElse",category:"boolean",description:"Conditional logic without else branch",parameters:[{name:"condition",type:"boolean",required:!0},{name:"trueValue",type:"string",required:!0}],execute:(t,s)=>t?s:null,javaTemplate:"ifWithoutElse({0}, {1})"},{name:"isNil",category:"boolean",description:"Check if value is null or undefined",parameters:[{name:"value",type:"string",required:!0}],execute:t=>t==null,javaTemplate:"isNil({0})"}],na=[{name:"fixValues",category:"conversion",description:"Fix and validate values according to specified format",parameters:[{name:"value",type:"string",required:!0,description:"Value to fix"},{name:"format",type:"string",required:!0,description:"Target format"}],execute:(t,s)=>t,javaTemplate:"fixValues({0}, {1})"}],oa=[{name:"currentDate",category:"date",description:"Get current date",parameters:[{name:"format",type:"string",required:!1,description:"Date format (optional)"}],execute:t=>new Date().toISOString(),javaTemplate:"currentDate({0})"},{name:"dateTrans",category:"date",description:"Transform date format",parameters:[{name:"date",type:"string",required:!0,description:"Input date"},{name:"fromFormat",type:"string",required:!0,description:"Input date format"},{name:"toFormat",type:"string",required:!0,description:"Output date format"},{name:"firstWeekday",type:"string",required:!1,description:"First day of week (Sunday, Monday, etc.)"},{name:"minDays",type:"number",required:!1,description:"Minimum days in first week"},{name:"lenient",type:"boolean",required:!1,description:"Enable lenient parsing"}],execute:(t,s,n,a,r,o)=>t,javaTemplate:"dateTrans({0}, {1}, {2}, {3}, {4}, {5})"},{name:"dateBefore",category:"date",description:"Check if first date is before second date",parameters:[{name:"date1",type:"string",required:!0},{name:"date2",type:"string",required:!0}],execute:(t,s)=>new Date(t)<new Date(s),javaTemplate:"dateBefore({0}, {1})"},{name:"dateAfter",category:"date",description:"Check if first date is after second date",parameters:[{name:"date1",type:"string",required:!0},{name:"date2",type:"string",required:!0}],execute:(t,s)=>new Date(t)>new Date(s),javaTemplate:"dateAfter({0}, {1})"},{name:"compareDates",category:"date",description:"Compare two dates (-1, 0, 1)",parameters:[{name:"date1",type:"string",required:!0},{name:"date2",type:"string",required:!0}],execute:(t,s)=>{const n=new Date(t),a=new Date(s);return n<a?-1:n>a?1:0},javaTemplate:"compareDates({0}, {1})"}],ia=[{name:"createIf",category:"node",description:"Create conditional node structure",parameters:[{name:"condition",type:"boolean",required:!0},{name:"value",type:"string",required:!0}],execute:(t,s)=>t?s:null,javaTemplate:"createIf({0}, {1})"},{name:"removeContexts",category:"node",description:"Remove context from node structure",parameters:[{name:"node",type:"string",required:!0}],execute:t=>t,javaTemplate:"removeContexts({0})"},{name:"replaceValue",category:"node",description:"Replace value in node structure",parameters:[{name:"node",type:"string",required:!0},{name:"oldValue",type:"string",required:!0},{name:"newValue",type:"string",required:!0}],execute:(t,s,n)=>t.replace(s,n),javaTemplate:"replaceValue({0}, {1}, {2})"},{name:"exists",category:"node",description:"Check if node exists",parameters:[{name:"node",type:"string",required:!0}],execute:t=>t!=null&&t!=="",javaTemplate:"exists({0})"},{name:"getHeader",category:"node",description:"Get header value from message",parameters:[{name:"headerName",type:"string",required:!0}],execute:t=>`header_${t}`,javaTemplate:"getHeader({0})"},{name:"getProperty",category:"node",description:"Get property value",parameters:[{name:"propertyName",type:"string",required:!0}],execute:t=>`property_${t}`,javaTemplate:"getProperty({0})"},{name:"splitByValue",category:"node",description:"Split node by delimiter",parameters:[{name:"value",type:"string",required:!0},{name:"delimiter",type:"string",required:!0}],execute:(t,s)=>t.split(s),javaTemplate:"splitByValue({0}, {1})"},{name:"collapseContexts",category:"node",description:"Collapse multiple contexts into one",parameters:[{name:"contexts",type:"array",required:!0}],execute:t=>t.join(""),javaTemplate:"collapseContexts({0})"},{name:"useOneAsMany",category:"node",description:"Replicate a field that occurs once to pair with fields that occur multiple times",parameters:[{name:"singleField",type:"string",required:!0,description:"Field that occurs 1..1 (once)"},{name:"countField",type:"string",required:!0,description:"Field that determines replication count"},{name:"multipleField",type:"string",required:!0,description:"Field that occurs multiple times and provides context"}],execute:(t,s,n)=>[t],javaTemplate:"useOneAsMany({0}, {1}, {2})"},{name:"sort",category:"node",description:"Sort array of values",parameters:[{name:"values",type:"array",required:!0}],execute:t=>[...t].sort(),javaTemplate:"sort({0})"},{name:"sortByKey",category:"node",description:"Sort array by specific key",parameters:[{name:"values",type:"array",required:!0},{name:"key",type:"string",required:!0}],execute:(t,s)=>[...t].sort((n,a)=>n[s]-a[s]),javaTemplate:"sortByKey({0}, {1})"},{name:"mapWithDefault",category:"node",description:"Map value with default fallback",parameters:[{name:"value",type:"string",required:!0},{name:"defaultValue",type:"string",required:!0}],execute:(t,s)=>t||s,javaTemplate:"mapWithDefault({0}, {1})"},{name:"formatByExample",category:"node",description:"Format value using example pattern",parameters:[{name:"value",type:"string",required:!0},{name:"example",type:"string",required:!0}],execute:(t,s)=>t,javaTemplate:"formatByExample({0}, {1})"}],ca=[{name:"constant",category:"constants",description:"Set a fixed value",parameters:[{name:"value",type:"string",required:!0,description:"The constant value to return"}],execute:t=>t,javaTemplate:'constant("{0}")'}],Je={math:aa,text:sa,boolean:ra,conversion:na,date:oa,node:ia,constants:ca},la=({open:t,onClose:s,selectedFunction:n,sourceFields:a,targetField:r,onApplyMapping:o})=>{const l=g.useRef(null),p=g.useRef(null),[x,j]=g.useState({id:"function_modal",functionName:n,parameters:{},sourceConnections:{},position:{x:0,y:0}}),[S,N]=g.useState([]),[C,c]=g.useState({isDragging:!1,draggedItem:null,startPosition:{x:0,y:0},currentPosition:{x:0,y:0}}),[f,b]=g.useState(new Set),[i,F]=g.useState(!1),h=Object.values(Je).flat().find(d=>d.name===n),y=g.useCallback((d,v)=>{v.preventDefault(),v.stopPropagation(),document.body.style.userSelect="none",document.body.style.webkitUserSelect="none",u.info(m.UI,"🎯 DRAG START - Field:",{data:d.name,Position:{x:v.clientX,y:v.clientY}}),u.info(m.UI,"🎯 DRAG START - Event target:",{data:v.target}),u.info(m.UI,"🎯 DRAG START - Event currentTarget:",{data:v.currentTarget}),c({isDragging:!0,draggedItem:d,startPosition:{x:v.clientX,y:v.clientY},currentPosition:{x:v.clientX,y:v.clientY}});const q=new Set;h?.parameters.forEach(L=>{!L.name.toLowerCase().includes("delimiter")&&!L.name.toLowerCase().includes("separator")&&(q.add(`param-${x.id}-${L.name}`),u.info(m.UI,"🎯 DRAG START - Added drop target:",{data:`param-${x.id}-${L.name}`}))}),b(q),u.info(m.UI,"🎯 DRAG START - Total drop targets:",{data:q.size})},[h,x.id]),E=g.useCallback(d=>{C.isDragging&&(u.info(m.UI,"🎯 DRAG MOVE - Position:",{x:d.clientX,y:d.clientY}),u.info(m.UI,"🎯 DRAG MOVE - Element under mouse",{data:document.elementFromPoint(d.clientX,d.clientY)}),c(v=>({...v,currentPosition:{x:d.clientX,y:d.clientY}})))},[C.isDragging]),P=g.useCallback(d=>{if(u.info(m.UI,"🎯 DRAG END - Starting mouse up handler"),u.info(m.UI,"🎯 DRAG END - isDragging:",{data:C.isDragging}),u.info(m.UI,"🎯 DRAG END - draggedItem:",{data:C.draggedItem}),!C.isDragging||!C.draggedItem){u.info(m.UI,"🎯 DRAG END - Early return - no drag in progress");return}u.info(m.UI,"🎯 DRAG END - Position:",{x:d.clientX,y:d.clientY});const v=document.elementFromPoint(d.clientX,d.clientY);u.info(m.UI,"🎯 DRAG END - Element under mouse:",{data:v}),u.info(m.UI,"🎯 DRAG END - Element tag:",{data:v?.tagName}),u.info(m.UI,"🎯 DRAG END - Element classes:",{data:v?.className}),u.info(m.UI,"🎯 DRAG END - Element data-param:",{data:v?.getAttribute("data-param")});const q=v?.closest("[data-param]");if(u.info(m.UI,"🎯 DRAG END - Drop zone found:",{data:q}),u.info(m.UI,"🎯 DRAG END - Drop zone data-param:",{data:q?.getAttribute("data-param")}),q){const L=q.getAttribute("data-param");if(L){u.info(m.UI,"🎯 DRAG END - ✅ SUCCESS! Dropped on parameter:",{data:L});const M=C.draggedItem;u.info(m.UI,"🎯 DRAG END - Source field:",{data:M}),j(G=>{const R={...G,sourceConnections:{...G.sourceConnections,[L]:[M.path]}};return u.info(m.UI,"🎯 DRAG END - Updated function node:",{data:R}),R}),setTimeout(()=>{u.info(m.UI,"🎯 DRAG END - Creating visual connection");const G=document.querySelector(`[data-field-id="${M.id}"]`),R=q;if(u.info(m.UI,"🎯 DRAG END - Source element found:",{data:G}),u.info(m.UI,"🎯 DRAG END - Target element found:",{data:R}),u.info(m.UI,"🎯 DRAG END - Canvas ref:",{data:l.current}),G&&R&&l.current){const $=l.current.getBoundingClientRect(),se=G.getBoundingClientRect(),ue=R.getBoundingClientRect();u.info(m.UI,"🎯 DRAG END - Canvas rect:",{data:$}),u.info(m.UI,"🎯 DRAG END - Source rect:",{data:se}),u.info(m.UI,"🎯 DRAG END - Target rect:",{data:ue});const W={id:`connection_${Date.now()}`,sourceId:M.id,targetId:`${x.id}-${L}`,sourceX:se.right-$.left,sourceY:se.top+se.height/2-$.top,targetX:ue.left-$.left,targetY:ue.top+ue.height/2-$.top};u.info(m.UI,"🎯 DRAG END - Connection created:",{data:W}),N(fe=>{const B=[...fe,W];return u.info(m.UI,"🎯 DRAG END - All connections:",{data:B}),B})}},100)}else u.info(m.UI,"🎯 DRAG END - ❌ No param name found on drop")}else u.info(m.UI,"🎯 DRAG END - ❌ No drop zone found");document.body.style.userSelect="",document.body.style.webkitUserSelect="",u.info(m.UI,"🎯 DRAG END - Resetting drag state"),c({isDragging:!1,draggedItem:null,startPosition:{x:0,y:0},currentPosition:{x:0,y:0}}),b(new Set),u.info(m.UI,"🎯 DRAG END - Complete!")},[C,x.id]);Ye.useEffect(()=>{if(u.info(m.UI,"🎯 DRAG STATE CHANGE - isDragging:",{data:C.isDragging}),u.info(m.UI,"🎯 DRAG STATE CHANGE - draggedItem:",{data:C.draggedItem?.name}),C.isDragging)return u.info(m.UI,"🎯 DRAG STATE CHANGE - Adding global mouse listeners"),document.addEventListener("mousemove",E),document.addEventListener("mouseup",P),()=>{u.info(m.UI,"🎯 DRAG STATE CHANGE - Removing global mouse listeners"),document.removeEventListener("mousemove",E),document.removeEventListener("mouseup",P)}},[C.isDragging,C.draggedItem?.name,E,P]);const D=g.useCallback(d=>{if(!r)return;d.dataTransfer.setData("text/plain","function-output"),d.dataTransfer.effectAllowed="move";const v=new Set;v.add(`target-${r.id}`),b(v)},[r]),_=g.useCallback(()=>{c({isDragging:!1,draggedItem:null,startPosition:{x:0,y:0},currentPosition:{x:0,y:0}}),b(new Set)},[]),J=g.useCallback(d=>{if(d.preventDefault(),d.dataTransfer.getData("text/plain")!=="function-output"||!r)return;F(!0);const q=document.querySelector('[data-function-output="true"]'),L=document.querySelector(`[data-target-field="${r.id}"]`);if(q&&L&&l.current){const M=l.current.getBoundingClientRect(),G=q.getBoundingClientRect(),R=L.getBoundingClientRect(),$={id:`connection_output_${Date.now()}`,sourceId:`${x.id}-output`,targetId:r.id,sourceX:G.right-M.left,sourceY:G.top+G.height/2-M.top,targetX:R.left-M.left,targetY:R.top+R.height/2-M.top};N(se=>[...se,$])}},[x.id,r]),A=g.useCallback(()=>{if(!h||!i||!r)return;const d=[],v=[];Object.values(x.sourceConnections).forEach(L=>{L.forEach(M=>{v.push(M),d.push(M.split(".").pop()||M)})});const q={id:`mapping_${Date.now()}`,name:`${n}_to_${r.name}`,sourceFields:d,targetField:r.name,sourcePaths:v,targetPath:r.path,functionNode:{...x,id:`function_${Date.now()}`},requiresTransformation:!0};o(q),s()},[h,i,x,n,r,o,s]);return h?e.jsx(pe,{open:t,onOpenChange:s,children:e.jsxs(he,{className:"max-w-6xl h-[80vh] p-0",children:[e.jsx(xe,{className:"p-6 pb-0",children:e.jsxs(ge,{className:"flex items-center justify-between",children:[e.jsxs("span",{children:["Function Mapping: ",h.name]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(O,{onClick:A,disabled:!i||Object.keys(x.sourceConnections).length===0,className:"bg-primary text-primary-foreground",children:[e.jsx(qt,{className:"h-4 w-4 mr-2"}),"Apply Function"]}),e.jsxs(O,{variant:"outline",onClick:s,className:"text-muted-foreground hover:text-foreground",children:[e.jsx(ce,{className:"h-4 w-4 mr-2"}),"Cancel"]})]})]})}),e.jsxs("div",{ref:l,className:"relative w-full flex-1 bg-background/50 overflow-hidden",children:[e.jsxs("svg",{ref:p,className:"absolute inset-0 w-full h-full pointer-events-none z-10",style:{overflow:"visible"},children:[e.jsx("defs",{children:e.jsx("marker",{id:"arrowhead-modal",markerWidth:"10",markerHeight:"7",refX:"9",refY:"3.5",orient:"auto",markerUnits:"strokeWidth",children:e.jsx("polygon",{points:"0 0, 10 3.5, 0 7",fill:"hsl(var(--primary))"})})}),S.map(d=>e.jsx("path",{d:`M ${d.sourceX} ${d.sourceY} C ${d.sourceX+100} ${d.sourceY}, ${d.targetX-100} ${d.targetY}, ${d.targetX} ${d.targetY}`,stroke:"hsl(var(--primary))",strokeWidth:"2",fill:"none",markerEnd:"url(#arrowhead-modal)"},d.id))]}),e.jsxs("div",{className:"flex justify-between items-start px-4 pt-4 space-x-4",children:[e.jsx("div",{className:"w-72 h-60 overflow-y-auto",children:e.jsxs("div",{className:"bg-card border rounded-lg p-2 shadow-sm h-full",children:[e.jsx("h3",{className:"font-semibold text-sm mb-2 text-primary",children:"Source Fields"}),e.jsx("div",{className:"space-y-2",children:a.map(d=>e.jsxs("div",{"data-field-id":d.id,className:Ne("bg-background border-2 rounded p-3 transition-all hover:shadow-lg hover:border-primary/50 select-none",C.isDragging&&C.draggedItem?.id===d.id&&"opacity-70 scale-95"),style:{cursor:C.isDragging&&C.draggedItem?.id===d.id?"grabbing":"grab"},onMouseDown:v=>{v.preventDefault(),y(d,v)},children:[e.jsx("div",{className:"font-medium text-sm pointer-events-none",children:d.name}),e.jsx("div",{className:"text-xs text-muted-foreground pointer-events-none",children:d.type})]},d.id))})]})}),e.jsxs("div",{className:"bg-card border-2 border-primary/20 rounded-lg shadow-lg overflow-visible w-60",style:{zIndex:5},children:[e.jsxs("div",{className:"bg-primary text-primary-foreground p-2 rounded-t-lg",children:[e.jsx("div",{className:"font-medium text-sm",children:h.name}),e.jsx("div",{className:"text-xs opacity-80",children:h.description})]}),e.jsx("div",{className:"p-2 space-y-2",children:h.parameters.map(d=>e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-xs",children:d.name}),e.jsx("div",{className:"text-xs text-muted-foreground mb-1",children:d.type}),d.name.toLowerCase().includes("delimiter")||d.name.toLowerCase().includes("separator")?e.jsx(ie,{placeholder:`Enter ${d.name}`,value:x.parameters[d.name]||"",onChange:v=>j(q=>({...q,parameters:{...q.parameters,[d.name]:v.target.value}})),className:"h-8 text-xs"}):e.jsxs("div",{"data-param":d.name,className:Ne("border-2 border-dashed border-muted-foreground/30 rounded p-2 text-sm transition-colors min-h-10",f.has(`param-${x.id}-${d.name}`)&&"border-primary bg-primary/10","hover:border-primary/50"),children:[x.sourceConnections[d.name]?.map((v,q)=>e.jsx("div",{className:"text-xs bg-primary/10 text-primary rounded px-1 py-0.5 mt-1 inline-block mr-1",children:v.split(".").pop()},q)),!x.sourceConnections[d.name]?.length&&e.jsx("div",{className:"text-xs text-muted-foreground italic",children:"Drop here"})]})]},d.name))}),e.jsxs("div",{"data-function-output":"true",className:"bg-success/10 border-t border-success/20 p-2 text-center cursor-grab hover:bg-success/20 transition-colors",draggable:"true",onDragStart:D,onDragEnd:_,children:[e.jsx("div",{className:"text-xs font-medium text-success",children:"Output"}),e.jsx("div",{className:"text-xs text-success/80",children:"Drag to target"})]})]}),r&&e.jsx("div",{className:"w-72",children:e.jsxs("div",{className:"bg-card border rounded-lg p-2 shadow-sm",children:[e.jsx("h3",{className:"font-semibold text-sm mb-2 text-primary",children:"Target Field"}),e.jsxs("div",{"data-target-field":r.id,className:Ne("bg-background border rounded p-3 transition-all",f.has(`target-${r.id}`)&&"border-primary bg-primary/10",i&&"border-success bg-success/10"),onDragOver:d=>d.preventDefault(),onDrop:J,children:[e.jsx("div",{className:"font-medium text-sm",children:r.name}),e.jsx("div",{className:"text-sm text-muted-foreground",children:r.type}),i&&e.jsx("div",{className:"text-xs text-success mt-2 font-medium",children:"✓ Function output connected"})]})]})})]})]}),e.jsx("div",{className:"border-t bg-muted/30 py-1 px-2 text-xs",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("div",{className:"text-muted-foreground",children:"Connect source → function → target"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:Ne("px-1.5 py-0.5 rounded",Object.keys(x.sourceConnections).length>0?"bg-success/20 text-success":"bg-muted text-muted-foreground"),children:["Params: ",Object.keys(x.sourceConnections).length,"/",h.parameters.length]}),e.jsxs("span",{className:Ne("px-1.5 py-0.5 rounded",i?"bg-success/20 text-success":"bg-muted text-muted-foreground"),children:["Output: ",i?"Connected":"Not connected"]})]})]})})]})}):null},da=({id:t,data:s})=>{const{field:n}=s,{setNodes:a,setEdges:r}=He(),o=()=>{a(l=>l.filter(p=>p.id!==t)),r(l=>l.filter(p=>p.source!==t&&p.target!==t))};return e.jsxs("div",{className:"bg-card border-2 border-muted rounded-lg p-3 min-w-[160px] shadow-sm relative group",children:[e.jsx(O,{variant:"ghost",size:"sm",onClick:o,className:"absolute -top-2 -right-2 h-6 w-6 p-0 bg-destructive text-destructive-foreground opacity-0 group-hover:opacity-100 transition-opacity rounded-full shadow-md hover:bg-destructive/80",title:"Delete source field",children:e.jsx(ce,{className:"h-3 w-3"})}),e.jsx("div",{className:"flex items-center gap-2 mb-2",children:e.jsx(Xe,{className:"h-4 w-4 text-blue-500"})}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"text-sm font-semibold text-primary",children:n.name}),e.jsx("div",{className:"text-xs text-muted-foreground",children:n.type}),e.jsx("div",{className:"text-xs text-muted-foreground truncate max-w-[140px]",title:n.path,children:n.path})]}),e.jsx(le,{type:"source",position:de.Right,className:"w-3 h-3 bg-blue-500 border-2 border-white"})]})};class ua{functionsCache=null;cacheExpiry=0;cacheDuration=5*60*1e3;async getAllFunctions(){if(this.functionsCache&&Date.now()<this.cacheExpiry)return this.functionsCache;try{const n=(await et.get("/development/functions")).builtInFunctions.map(a=>{let r=[];if(a.parameters)r=a.parameters;else{const o=a.signature.match(/\((.*)\)/);o&&o[1]&&(r=o[1].split(",").map(p=>p.trim()).map(p=>({name:p,type:"any",required:!0})))}return{name:a.name,category:a.category,description:a.description,parameters:r,isBuiltIn:!0,execute:this.getExecuteFunction(a.name),javaTemplate:this.getJavaTemplate(a.name,r)}});return this.functionsCache=n,this.cacheExpiry=Date.now()+this.cacheDuration,n}catch(s){return u.error(m.API,"Failed to fetch functions from API",{error:s}),[]}}async getBuiltInFunctionByName(s){try{const n=await et.get(`/development/functions/built-in/${s}`);if(n.parameters&&typeof n.parameters=="string")try{n.parameters=JSON.parse(n.parameters)}catch(a){u.error(m.API,"Failed to parse parameters",{error:a}),n.parameters=[]}return n}catch(n){return u.error(m.API,"Failed to fetch function by name",{error:n}),null}}clearCache(){this.functionsCache=null,this.cacheExpiry=0}getExecuteFunction(s){return{add:(a,r)=>a+r,subtract:(a,r)=>a-r,multiply:(a,r)=>a*r,divide:(a,r)=>a/r,equals:(a,r)=>a===r,absolute:a=>Math.abs(a),sqrt:a=>Math.sqrt(a),square:a=>a*a,sign:a=>Math.sign(a),neg:a=>-a,inv:a=>1/a,power:(a,r)=>Math.pow(a,r),lesser:(a,r)=>a<r,greater:(a,r)=>a>r,max:(a,r)=>Math.max(a,r),min:(a,r)=>Math.min(a,r),ceil:a=>Math.ceil(a),floor:a=>Math.floor(a),round:a=>Math.round(a),counter:(a=0,r=1)=>a+r,formatNumber:(a,r,o)=>a.toFixed(o||0).padStart(r,"0"),sum:a=>a.reduce((r,o)=>r+o,0),average:a=>a.reduce((r,o)=>r+o,0)/a.length,count:a=>a.length,index:a=>a,concat:(a,r,o)=>o?`${a}${o}${r}`:`${a}${r}`,substring:(a,r,o)=>a.substring(r,o),indexOf:(a,r)=>a.indexOf(r),lastIndexOf:(a,r)=>a.lastIndexOf(r),compare:(a,r)=>a.localeCompare(r),replaceString:(a,r,o)=>a.replace(new RegExp(r,"g"),o),length:a=>a.length,endsWith:(a,r)=>a.endsWith(r),startsWith:(a,r)=>a.startsWith(r),toUpperCase:a=>a.toUpperCase(),toLowerCase:a=>a.toLowerCase(),trim:a=>a.trim(),and:(a,r)=>a&&r,or:(a,r)=>a||r,not:a=>!a,notEquals:(a,r)=>a!==r,if:(a,r,o)=>a?r:o,ifWithoutElse:(a,r)=>a?r:void 0,isNil:a=>a==null,constant:a=>a,fixValues:(a,r)=>a}[s]}getJavaTemplate(s,n){const a=n.map((r,o)=>`{${o}}`).join(", ");return`${s}(${a})`}}const yt=new ua,ma=({id:t,data:s})=>{const[n,a]=g.useState(s.function),[r,o]=g.useState(s.parameters),[l,p]=g.useState(!1),[x,j]=g.useState([]),[S,N]=g.useState(!1),{setNodes:C,setEdges:c}=He();g.useEffect(()=>{(async()=>{N(!0);try{const y=await yt.getAllFunctions();if(j(y),"isBuiltIn"in s.function&&s.function.isBuiltIn){const E=y.find(P=>P.name===s.function.name);E&&a(E)}}catch(y){u.error(m.UI,"Failed to load functions",{error:y})}finally{N(!1)}})()},[s.function]);const f=h=>["string1","string2","text","input","value","a","b","array","object","source","target"].some(P=>h.name.toLowerCase().includes(P))||n.parameters.indexOf(h)===0&&h.required?!0:["delimiter","format","separator","pattern","start","end","length","index"].some(P=>h.name.toLowerCase().includes(P))?!1:h.required,b=g.useMemo(()=>{const h=Object.values(Je).flat(),y=new Map;return h.forEach(E=>{y.set(E.name,E)}),x.forEach(E=>{y.set(E.name,E)}),Array.from(y.values())},[x]),i=h=>{const y=b.find(E=>E.name===h);y&&(a(y),o({}))},F=(h,y)=>{const E={...r,[h]:y};o(E),C(P=>P.map(D=>D.id===t?{...D,data:{...D.data,parameters:E}}:D))},T=()=>{C(h=>h.filter(y=>y.id!==t)),c(h=>h.filter(y=>y.source!==t&&y.target!==t))};return e.jsxs("div",{className:"bg-card border-2 border-orange-200 rounded-lg p-3 min-w-[200px] shadow-sm relative group",children:[e.jsx(O,{variant:"ghost",size:"sm",onClick:T,className:"absolute -top-2 -right-2 h-6 w-6 p-0 bg-destructive text-destructive-foreground opacity-0 group-hover:opacity-100 transition-opacity rounded-full shadow-md hover:bg-destructive/80",title:"Delete function",children:e.jsx(ce,{className:"h-3 w-3"})}),e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(qe,{className:"h-4 w-4 text-orange-500"})}),e.jsx(O,{size:"sm",variant:"ghost",onClick:h=>{h.preventDefault(),h.stopPropagation(),p(!l)},className:"h-6 w-6 p-0 hover:bg-muted rounded",children:e.jsx(it,{className:`h-3 w-3 ${l?"text-primary":""}`})})]}),s.showSelector?e.jsxs(we,{value:n.name,onValueChange:i,disabled:S,children:[e.jsx(Ce,{className:"w-full text-xs",children:e.jsx(Se,{})}),e.jsx(Fe,{children:(()=>{const h=b.reduce((y,E)=>{const P=E.category||"general";return y[P]||(y[P]=[]),y[P].push(E),y},{});return Object.entries(h).map(([y,E])=>e.jsxs("div",{children:[e.jsx("div",{className:"px-2 py-1 text-xs font-semibold text-muted-foreground uppercase",children:y}),E.map(P=>e.jsx(Q,{value:P.name,className:"text-xs",children:P.name},P.name))]},y))})()})]}):e.jsxs("div",{className:"text-sm font-semibold text-primary flex items-center gap-2",children:[s.isCustom&&e.jsx(ct,{className:"h-3 w-3"}),n.name]}),e.jsx("div",{className:"text-xs text-muted-foreground mt-1 mb-3",children:n.description}),l&&e.jsx("div",{className:"space-y-2 mb-3 border-t pt-2 bg-muted/20 rounded p-2",children:s.isCustom?e.jsxs("div",{className:"space-y-2",children:[e.jsx(ae,{className:"text-xs font-medium",children:"Custom Java Code"}),e.jsx(Ve,{placeholder:"Enter your custom Java transformation code here...",className:"h-20 text-xs font-mono",value:r.customCode||"",onChange:h=>F("customCode",h.target.value)}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Write Java code to transform input values. Use 'input' variable to access connected fields."})]}):e.jsxs(e.Fragment,{children:[e.jsx(ae,{className:"text-xs font-medium",children:"Parameters"}),n.parameters.filter(h=>!f(h)).length===0?e.jsx("div",{className:"text-xs text-muted-foreground",children:"No configurable parameters"}):n.parameters.filter(h=>!f(h)).map(h=>e.jsxs("div",{className:"space-y-1",children:[e.jsxs(ae,{className:"text-xs",children:[h.name,h.required&&e.jsx("span",{className:"text-destructive ml-1",children:"*"})]}),e.jsx(ie,{placeholder:`${h.type} value`,value:r[h.name]||"",onChange:y=>F(h.name,y.target.value),className:"h-6 text-xs"}),h.description&&e.jsx("div",{className:"text-xs text-muted-foreground",children:h.description})]},h.name))]})}),n.parameters.map((h,y)=>f(h)?e.jsx(le,{type:"target",position:de.Left,id:h.name,style:{top:`${60+y*20}px`,background:"#f97316",width:"8px",height:"8px"},className:"border-2 border-white"},`input-${h.name}`):null),e.jsx(le,{type:"source",position:de.Right,className:"w-3 h-3 bg-orange-500 border-2 border-white"})]})},pa=({data:t})=>{const[s,n]=g.useState(t.value),[a,r]=g.useState(t.type);return e.jsxs("div",{className:"bg-card border-2 border-green-200 rounded-lg p-3 min-w-[160px] shadow-sm",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(Zt,{className:"h-4 w-4 text-green-500"}),e.jsx("span",{className:"text-sm font-medium text-foreground",children:"Constant"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(we,{value:a,onValueChange:o=>r(o),children:[e.jsx(Ce,{className:"w-full h-7 text-xs",children:e.jsx(Se,{})}),e.jsxs(Fe,{children:[e.jsx(Q,{value:"string",children:"String"}),e.jsx(Q,{value:"number",children:"Number"}),e.jsx(Q,{value:"boolean",children:"Boolean"})]})]}),a==="boolean"?e.jsxs(we,{value:s,onValueChange:n,children:[e.jsx(Ce,{className:"w-full h-7 text-xs",children:e.jsx(Se,{})}),e.jsxs(Fe,{children:[e.jsx(Q,{value:"true",children:"true"}),e.jsx(Q,{value:"false",children:"false"})]})]}):e.jsx(ie,{placeholder:`Enter ${a} value`,value:s,onChange:o=>n(o.target.value),type:a==="number"?"number":"text",className:"h-7 text-xs"}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:["Value: ",e.jsx("span",{className:"font-mono",children:s||"undefined"})]})]}),e.jsx(le,{type:"source",position:de.Right,className:"w-3 h-3 bg-green-500 border-2 border-white"})]})},ha=({data:t})=>{const{field:s}=t;return e.jsxs("div",{className:"bg-card border-2 border-purple-200 rounded-lg p-3 min-w-[160px] shadow-sm",children:[e.jsx("div",{className:"flex items-center gap-2 mb-2",children:e.jsx(Qt,{className:"h-4 w-4 text-purple-500"})}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"text-sm font-semibold text-primary",children:s.name}),e.jsx("div",{className:"text-xs text-muted-foreground",children:s.type}),e.jsx("div",{className:"text-xs text-muted-foreground truncate max-w-[140px]",title:s.path,children:s.path})]}),e.jsx(le,{type:"target",position:de.Left,className:"w-3 h-3 bg-purple-500 border-2 border-white"})]})},xa=({data:t})=>{const[s,n]=g.useState(t.condition),[a,r]=g.useState(t.compareValue);return e.jsxs("div",{className:"bg-card border-2 border-yellow-200 rounded-lg p-3 min-w-[180px] shadow-sm",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(Jt,{className:"h-4 w-4 text-yellow-500"}),e.jsx("span",{className:"text-sm font-medium text-foreground",children:"Conditional"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{children:[e.jsx(ae,{className:"text-xs",children:"Condition"}),e.jsxs(we,{value:s,onValueChange:o=>n(o),children:[e.jsx(Ce,{className:"w-full h-7 text-xs",children:e.jsx(Se,{})}),e.jsxs(Fe,{children:[e.jsx(Q,{value:"equals",children:"Equals"}),e.jsx(Q,{value:"notEquals",children:"Not Equals"}),e.jsx(Q,{value:"contains",children:"Contains"}),e.jsx(Q,{value:"startsWith",children:"Starts With"}),e.jsx(Q,{value:"endsWith",children:"Ends With"}),e.jsx(Q,{value:"isEmpty",children:"Is Empty"}),e.jsx(Q,{value:"isNotEmpty",children:"Is Not Empty"})]})]})]}),!["isEmpty","isNotEmpty"].includes(s)&&e.jsxs("div",{children:[e.jsx(ae,{className:"text-xs",children:"Compare Value"}),e.jsx(ie,{placeholder:"Value to compare",value:a,onChange:o=>r(o.target.value),className:"h-7 text-xs"})]})]}),e.jsx(le,{type:"target",position:de.Left,id:"input",className:"w-3 h-3 bg-yellow-500 border-2 border-white",style:{top:40}}),e.jsx(le,{type:"source",position:de.Right,id:"true",className:"w-3 h-3 bg-green-500 border-2 border-white",style:{top:35}}),e.jsx(le,{type:"source",position:de.Right,id:"false",className:"w-3 h-3 bg-red-500 border-2 border-white",style:{top:55}}),e.jsx("div",{className:"absolute -right-8 top-7 text-xs text-green-600 font-medium",children:"T"}),e.jsx("div",{className:"absolute -right-8 top-12 text-xs text-red-600 font-medium",children:"F"})]})},ga=({open:t,onClose:s,sourceFields:n,onSelectField:a,excludeFields:r=[]})=>{const[o,l]=g.useState(""),[p,x]=g.useState(new Set),j=i=>{x(F=>{const T=new Set(F);return T.has(i)?T.delete(i):T.add(i),T})},S=i=>{a(i),s(),l(""),x(new Set)},N=(i,F=0)=>{const T=!i.children||i.children.length===0,h=p.has(i.id),y=r.includes(i.id),E=!o||i.name.toLowerCase().includes(o.toLowerCase())||i.path.toLowerCase().includes(o.toLowerCase())||i.type.toLowerCase().includes(o.toLowerCase()),P=i.children?.some(D=>D.name.toLowerCase().includes(o.toLowerCase())||D.path.toLowerCase().includes(o.toLowerCase())||D.type.toLowerCase().includes(o.toLowerCase()));return!E&&!P?null:e.jsxs("div",{className:"w-full",children:[e.jsxs("div",{className:`flex items-center p-2 border rounded-md transition-colors ${y?"bg-muted/50 opacity-50":T?"hover:bg-primary/10 cursor-pointer border-dashed":"hover:bg-muted/50"}`,style:{marginLeft:`${F*16}px`},onClick:()=>{T&&!y?S(i):T||j(i.id)},children:[!T&&e.jsx(O,{variant:"ghost",size:"sm",onClick:D=>{D.stopPropagation(),j(i.id)},className:"mr-2 h-auto w-auto p-1 hover:bg-muted rounded",children:h?e.jsx(nt,{className:"h-3 w-3"}):e.jsx(ot,{className:"h-3 w-3"})}),e.jsxs("div",{className:"flex-1 flex items-center gap-2",children:[e.jsx(Xe,{className:"h-3 w-3 text-info flex-shrink-0"}),e.jsx("span",{className:"font-medium text-sm",children:i.name}),e.jsx(ne,{variant:"outline",className:"text-xs",children:i.type}),y&&e.jsx(ne,{variant:"secondary",className:"text-xs",children:"Already added"})]}),T&&!y&&e.jsx("span",{className:"text-xs text-muted-foreground",children:"Click to select"})]}),!T&&h&&i.children&&e.jsx("div",{className:"ml-2",children:i.children.map(D=>N(D,F+1))})]},i.id)},C=i=>{const F=[],T=h=>{!h.children||h.children.length===0?F.push(h):h.children.forEach(T)};return i.forEach(T),F},c=n.filter(i=>!r.includes(i.id)),f=C(n).length,b=C(c).length;return e.jsx(pe,{open:t,onOpenChange:s,children:e.jsxs(he,{className:"max-w-2xl h-[80vh] flex flex-col",children:[e.jsx(xe,{className:"flex-shrink-0",children:e.jsxs(ge,{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{children:"Select Source Field"}),e.jsxs(ne,{variant:"outline",className:"text-xs",children:[b," of ",f," available"]})]}),e.jsx(O,{variant:"ghost",size:"sm",onClick:s,children:e.jsx(ce,{className:"h-4 w-4"})})]})}),e.jsx("div",{className:"flex-shrink-0 mb-4",children:e.jsxs("div",{className:"relative",children:[e.jsx(Pe,{className:"absolute left-3 top-3 h-4 w-4 text-muted-foreground"}),e.jsx(ie,{placeholder:"Search fields by name, path, or type...",value:o,onChange:i=>l(i.target.value),className:"pl-10"})]})}),e.jsx(mt,{className:"flex-1",children:e.jsx("div",{className:"space-y-2 pr-4",children:c.length===0?e.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[e.jsx(Xe,{className:"h-8 w-8 mx-auto mb-2 opacity-50"}),e.jsx("p",{children:"No available source fields to add"})]}):c.map(i=>N(i))})}),e.jsx("div",{className:"flex-shrink-0 pt-4 border-t",children:e.jsx("div",{className:"text-sm text-muted-foreground",children:"Click on any leaf field (shown with dashed border) to add it to your flow"})})]})})},fa=({open:t,onClose:s,onSelectFunction:n})=>{const[a,r]=g.useState(""),[o,l]=g.useState([]),[p,x]=g.useState(!1);g.useEffect(()=>{t&&(async()=>{x(!0);try{const b=await yt.getAllFunctions();l(b)}catch(b){u.error(m.UI,"Failed to load functions",{error:b})}finally{x(!1)}})()},[t]);const j=Ye.useMemo(()=>{const f={};return Object.entries(Je).forEach(([b,i])=>{f[b]=[...i]}),o.forEach(b=>{const i=b.category||"general";f[i]||(f[i]=[]),f[i]=f[i].filter(F=>F.name!==b.name),f[i].push(b)}),f},[o]),S=Object.entries(j).reduce((f,[b,i])=>{const F=i.filter(T=>T.name.toLowerCase().includes(a.toLowerCase())||T.description.toLowerCase().includes(a.toLowerCase()));return F.length>0&&(f[b]=F),f},{}),N=f=>{n(f),s(),r("")},C=Object.values(j).flat().length,c=Object.values(S).flat().length;return e.jsx(pe,{open:t,onOpenChange:s,children:e.jsxs(he,{className:"max-w-4xl h-[80vh] flex flex-col",children:[e.jsx(xe,{className:"flex-shrink-0",children:e.jsxs(ge,{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Oe,{className:"h-5 w-5 text-primary"}),e.jsx("span",{children:"Select Function"}),e.jsxs(ne,{variant:"outline",className:"text-xs",children:[c," of ",C," functions"]})]}),e.jsx(O,{variant:"ghost",size:"sm",onClick:s,children:e.jsx(ce,{className:"h-4 w-4"})})]})}),e.jsx("div",{className:"flex-shrink-0 mb-4",children:e.jsxs("div",{className:"relative",children:[e.jsx(Pe,{className:"absolute left-3 top-3 h-4 w-4 text-muted-foreground"}),e.jsx(ie,{placeholder:"Search functions by name or description...",value:a,onChange:f=>r(f.target.value),className:"pl-10"})]})}),e.jsx("div",{className:"flex-1 overflow-hidden",children:p?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(De,{className:"h-8 w-8 mx-auto mb-2 animate-spin text-primary"}),e.jsx("p",{className:"text-muted-foreground",children:"Loading functions..."})]}):Object.keys(S).length===0?e.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[e.jsx(Oe,{className:"h-8 w-8 mx-auto mb-2 opacity-50"}),e.jsx("p",{children:"No functions found matching your search"})]}):e.jsxs(pt,{defaultValue:Object.keys(S)[0],className:"h-full flex flex-col",children:[e.jsx(ht,{className:"grid w-full flex-shrink-0",style:{gridTemplateColumns:`repeat(${Object.keys(S).length}, 1fr)`},children:Object.keys(S).map(f=>e.jsxs(ze,{value:f,className:"capitalize text-xs",children:[f," (",S[f].length,")"]},f))}),Object.entries(S).map(([f,b])=>e.jsx(Be,{value:f,className:"flex-1 mt-4",children:e.jsx(mt,{className:"h-full",children:e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3 pr-4",children:b.map(i=>e.jsxs(Ie,{className:"cursor-pointer hover:bg-primary/10 transition-colors border-dashed hover:border-primary",onClick:()=>N(i),children:[e.jsx(Re,{className:"pb-2",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs(Ae,{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(Oe,{className:"h-3 w-3 text-primary"}),i.name]}),e.jsx(Ge,{className:"text-xs mt-1",children:i.description})]}),e.jsx(ne,{variant:"secondary",className:"text-xs ml-2",children:i.category})]})}),e.jsx(Le,{className:"pt-0",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("span",{className:"text-xs text-muted-foreground",children:[i.parameters.length," parameter",i.parameters.length!==1?"s":""]}),e.jsx("span",{className:"text-xs text-primary font-medium",children:"Click to add"})]})})]},i.name))})})},f))]})}),e.jsx("div",{className:"flex-shrink-0 pt-4 border-t",children:e.jsx("div",{className:"text-sm text-muted-foreground",children:"Select a function to add it to your flow. You can configure parameters after adding."})})]})})},ya=({id:t,sourceX:s,sourceY:n,targetX:a,targetY:r,sourcePosition:o,targetPosition:l,style:p={},markerEnd:x,selected:j=!1})=>{const{setEdges:S}=He(),[N,C,c]=It({sourceX:s,sourceY:n,sourcePosition:o,targetX:a,targetY:r,targetPosition:l}),f=b=>{b.stopPropagation(),S(i=>i.filter(F=>F.id!==t))};return e.jsxs(e.Fragment,{children:[";",e.jsx(Rt,{path:N,markerEnd:x,style:p}),j&&e.jsx(At,{children:e.jsx("div",{className:"absolute pointer-events-auto",style:{transform:`translate(-50%, -50%) translate(${C}px,${c}px)`},children:e.jsx(O,{variant:"ghost",size:"sm",onClick:f,className:"h-6 w-6 p-0 bg-destructive text-destructive-foreground hover:bg-destructive/80 rounded-full shadow-md",title:"Delete connection",children:e.jsx(ce,{className:"h-3 w-3"})})})})]})},ja={sourceField:da,function:ma,constant:pa,targetField:ha,conditional:xa},va={deletable:ya},Na=({open:t,onClose:s,sourceFields:n,targetField:a,onApplyMapping:r,initialMapping:o})=>{const[l,p,x]=Lt([]),[j,S,N]=Pt([]),[C,c]=g.useState(1),[f,b]=g.useState(!1),[i,F]=g.useState(!1);Ye.useEffect(()=>{if(t&&a){let A=[],d=[],v=1;if(o?.visualFlowData)A=o.visualFlowData.nodes,d=o.visualFlowData.edges,v=o.visualFlowData.nodeIdCounter;else{A.push({id:"target",type:"targetField",position:{x:800,y:200},data:{field:a}});const L=(M,G,R)=>{for(const $ of M){if($.name===G||$.path===G||R&&$.path===R)return $;if($.children&&$.children.length>0){const se=L($.children,G,R);if(se)return se}}};o&&o.sourcePaths&&o.sourcePaths.length>0?o.sourcePaths.forEach((M,G)=>{let R=n.find($=>$.path===M||$.name===M);if(R||(R=L(n,M,M)),!R&&o.sourceFields&&o.sourceFields[G]){const $=o.sourceFields[G];R={id:`source_${$}_${Date.now()}_${G}`,name:$,type:"string",path:M,expanded:!1}}if(R){const $=`source-${R.id}`;A.push({id:$,type:"sourceField",position:{x:50,y:50+G*100},data:{field:R}}),d.push({id:`edge-${$}-target`,source:$,target:"target",type:"deletable",animated:!1,style:{stroke:"hsl(var(--primary))",strokeWidth:2},markerEnd:{type:be.ArrowClosed,color:"hsl(var(--primary))"}})}}):o&&o.sourceFields&&o.sourceFields.length>0&&o.sourceFields.forEach((M,G)=>{let R=n.find($=>$.name===M||$.path===M);if(R||(R=L(n,M,M)),R||(R={id:`source_${M}_${Date.now()}_${G}`,name:M,type:"string",path:M,expanded:!1}),R){const $=`source-${R.id}`;A.push({id:$,type:"sourceField",position:{x:50,y:50+G*100},data:{field:R}}),d.push({id:`edge-${$}-target`,source:$,target:"target",type:"deletable",animated:!1,style:{stroke:"hsl(var(--primary))",strokeWidth:2},markerEnd:{type:be.ArrowClosed,color:"hsl(var(--primary))"}})}})}v=2+(o?.sourcePaths?.length||o?.sourceFields?.length||0),p(A),S(d),c(v)}},[t,a,n,o,p,S]);const T=g.useCallback(A=>{if(A.target==="target")S(d=>{const v=d.filter(L=>L.target!=="target"),q={...A,type:"deletable",animated:!1,style:{stroke:"hsl(var(--primary))",strokeWidth:2},markerEnd:{type:be.ArrowClosed,color:"hsl(var(--primary))"}};return st(q,v)});else{const d={...A,type:"deletable",animated:!1,style:{stroke:"hsl(var(--primary))",strokeWidth:2},markerEnd:{type:be.ArrowClosed,color:"hsl(var(--primary))"}};S(v=>st(d,v))}},[S]),h=g.useCallback(()=>{b(!0)},[]),y=g.useCallback(A=>{const d=l.filter(q=>q.type==="sourceField"),v={id:`source-${A.id}`,type:"sourceField",position:{x:50,y:50+d.length*100},data:{field:A}};p(q=>[...q,v])},[l,p]),E=g.useCallback(()=>{F(!0)},[]),P=g.useCallback(A=>{const d=l.filter(q=>q.type==="function"),v={id:`function-${C}`,type:"function",position:{x:350,y:50+d.length*120},data:{function:A,parameters:{},showSelector:!1}};p(q=>[...q,v]),c(q=>q+1)},[C,l,p]),D=g.useCallback(()=>{const A=l.filter(v=>v.type==="function"&&v.data.function.name==="custom"),d={id:`custom-function-${C}`,type:"function",position:{x:350,y:50+A.length*120},data:{function:{name:"custom",description:"Custom Java function",category:"custom",parameters:[],javaCode:""},parameters:{},showSelector:!1,isCustom:!0}};p(v=>[...v,d]),c(v=>v+1)},[C,l,p]),_=g.useCallback(()=>{if(!a||(u.info(m.UI,"🔥 VisualFlowEditor handleSave - saving with nodes",{data:l.length,edges:j.length}),!l.find(L=>L.type==="targetField")))return;const d=[],v=[];l.forEach(L=>{L.type==="sourceField"&&j.some(G=>G.source===L.id)&&(d.push(L.data.field.path),v.push(L.data.field.name))}),u.info(m.UI,"🔥 VisualFlowEditor handleSave - connectedSourcePaths",{data:d}),u.info(m.UI,"🔥 VisualFlowEditor handleSave - connectedSourceFields",{data:v});const q={id:o?.id||`mapping_${Date.now()}`,name:o?.name||`visual_flow_to_${a.name}`,sourceFields:v,targetField:a.name,sourcePaths:d,targetPath:a.path||a.name,requiresTransformation:!0,visualFlowData:{nodes:l,edges:j,nodeIdCounter:C},functionNode:{id:"visual_flow",functionName:"visual_flow",parameters:{},sourceConnections:{},position:{x:0,y:0}}};u.info(m.UI,"🔥 VisualFlowEditor handleSave - final mapping",{data:q}),r(q),s()},[l,j,C,a,o,r,s]),J=g.useMemo(()=>{const A=l.find(v=>v.type==="targetField");return A?j.some(v=>v.target===A.id):!1},[l,j]);return e.jsx(pe,{open:t,onOpenChange:s,children:e.jsxs(he,{className:"max-w-[98vw] h-[95vh] p-0 max-h-[95vh]",children:[e.jsx(xe,{className:"p-4 pb-2 border-b bg-muted/30",children:e.jsxs(ge,{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"text-lg font-semibold",children:"Visual Flow Editor"}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:["Target: ",e.jsx("span",{className:"font-medium text-primary",children:a?.name})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(O,{onClick:_,disabled:!J,className:"bg-primary text-primary-foreground",children:[e.jsx(Vt,{className:"h-4 w-4 mr-2"}),"Save Flow"]}),e.jsxs(O,{variant:"outline",onClick:s,children:[e.jsx(ce,{className:"h-4 w-4 mr-2"}),"Cancel"]})]})]})}),e.jsx("div",{className:"flex-1 relative h-[calc(95vh-80px)]",children:e.jsxs(Ut,{nodes:l,edges:j,onNodesChange:x,onEdgesChange:N,onConnect:T,nodeTypes:ja,edgeTypes:va,connectionMode:Ot.Loose,fitView:!0,fitViewOptions:{padding:.1,minZoom:.5,maxZoom:2},defaultEdgeOptions:{type:"deletable",animated:!1,style:{stroke:"hsl(var(--primary))",strokeWidth:2},markerEnd:{type:be.ArrowClosed,color:"hsl(var(--primary))"}},className:"bg-background",children:[e.jsx(_t,{gap:20,size:1}),e.jsx(Gt,{}),e.jsx(Xt,{className:"bg-background border border-border",pannable:!0,zoomable:!0,nodeColor:"hsl(var(--primary))"}),e.jsx(rt,{position:"top-left",className:"bg-card border rounded-lg p-3 shadow-lg min-w-[200px]",children:e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("h3",{className:"text-sm font-semibold text-primary mb-2 border-b border-border pb-2",children:"Add Nodes"}),e.jsxs(O,{onClick:h,size:"sm",variant:"outline",className:"justify-start h-9",children:[e.jsx(zt,{className:"h-4 w-4 mr-2"}),"Source Field"]}),e.jsxs(O,{onClick:E,size:"sm",variant:"outline",className:"justify-start h-9",children:[e.jsx(qe,{className:"h-4 w-4 mr-2"}),"Function"]}),e.jsxs(O,{onClick:D,size:"sm",variant:"outline",className:"justify-start h-9",children:[e.jsx(ct,{className:"h-4 w-4 mr-2"}),"Custom Function"]})]})}),e.jsx(rt,{position:"bottom-right",className:"bg-card border rounded-lg p-3 shadow-lg",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:`w-2 h-2 rounded-full ${J?"bg-green-500":"bg-red-500"}`}),e.jsx("div",{className:"text-sm font-medium",children:J?"Flow is valid - ready to save":"Connect nodes to target field"})]})})]})}),e.jsx(ga,{open:f,onClose:()=>b(!1),sourceFields:n,onSelectField:y,excludeFields:l.filter(A=>A.type==="sourceField").map(A=>A.data.field.id)}),e.jsx(fa,{open:i,onClose:()=>F(!1),onSelectFunction:P})]})})};function ba({mappings:t,sourceFields:s=[],targetFields:n=[],onRemoveMapping:a,onUpdateMapping:r,onCreateMapping:o}){const[l,p]=g.useState({open:!1,selectedFunction:"",targetField:null,filteredSourceFields:[]}),[x,j]=g.useState({open:!1,targetField:null});g.useEffect(()=>{u.info(m.UI,"🔍 Modal state changed",{data:l})},[l]),g.useEffect(()=>{u.info(m.UI,"🔥 Visual flow editor state changed",{data:x})},[x]);const S=c=>{u.info(m.UI,"🔥 handleOpenVisualFlowEditor called with mappingId",{data:c}),u.info(m.UI,"🔥 Available mappings",{data:t}),u.info(m.UI,"🔥 Available targetFields",{data:n}),u.info(m.UI,"🔥 Target fields names",{data:n.map(i=>i?.name)});const f=t.find(i=>i.id===c);if(u.info(m.UI,"🔥 Found existing mapping",{data:f}),!f){u.info(m.UI,"❌ No existing mapping found for ID",{data:c});return}let b=n.find(i=>i?.name===f.targetField);if(!b&&f.targetPath&&(b=n.find(i=>i?.path===f.targetPath)),!b){const i=(F,T,h)=>{for(const y of F){if(y.name===T||h&&y.path===h)return y;if(y.children&&y.children.length>0){const E=i(y.children,T,h);if(E)return E}}};b=i(n,f.targetField,f.targetPath)}if(u.info(m.UI,"🔥 Looking for target field with name",{data:f.targetField}),u.info(m.UI,"🔥 Looking for target field with path",{data:f.targetPath}),u.info(m.UI,"🔥 Found target field",{data:b}),!b){u.info(m.UI,"❌ Target field not found, attempting to create a proper target field from mapping data");let i=f.targetField;const F=f.targetPath||f.targetField;if(f.targetPath&&f.targetPath.includes(".")){const h=f.targetPath.split(".");i=h[h.length-1]}const T={id:`target_${i}_${Date.now()}`,name:i,type:"string",path:F,children:[],expanded:!1};u.info(m.UI,"🔥 Created proper target field",{data:T}),j({open:!0,targetField:T,existingMapping:f});return}u.info(m.UI,"Debug info",{message:"✅ Opening visual flow editor with",targetField:b.name,existingMapping:f.id}),j({open:!0,targetField:b,existingMapping:f})},N=c=>{u.info(m.UI,"🔥 handleApplyVisualFlow called with",{data:c}),x.existingMapping?r&&r(x.existingMapping.id,{functionNode:c.functionNode,visualFlowData:c.visualFlowData,requiresTransformation:!0,sourceFields:c.sourceFields,sourcePaths:c.sourcePaths,name:c.name}):o&&o(c),j({open:!1,targetField:null})},C=c=>{l.existingMappingId?r&&r(l.existingMappingId,{functionNode:c.functionNode,requiresTransformation:!0,sourceFields:c.sourceFields,sourcePaths:c.sourcePaths}):o&&o(c),p({open:!1,selectedFunction:"",targetField:null,filteredSourceFields:[]})};return u.info(m.UI,"🔍 MappingArea render - mappings count",{data:t.length}),u.info(m.UI,"🔍 MappingArea render - mappings",{data:t}),e.jsxs("div",{className:"w-1/3 relative bg-background animate-fade-in",children:[e.jsx("div",{className:"p-4 border-b",children:e.jsxs("h3",{className:"font-semibold flex items-center gap-2",children:[e.jsx(tt,{className:"h-4 w-4"}),"Field Mappings (",t.length,")"]})}),e.jsx("div",{className:"p-4 h-[calc(100%-60px)] overflow-y-auto",children:t.length===0?e.jsx(Te,{className:"mt-8",children:e.jsx(Ee,{children:"Drag fields from source to target to create mappings"})}):e.jsx("div",{className:"space-y-3",children:t.map(c=>e.jsxs("div",{className:"p-3 border rounded-lg bg-muted/30 animate-scale-in",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ne,{variant:"outline",className:"text-xs",children:c.sourceFields&&c.sourceFields.length>1?"Multi-Source Mapping":"Mapping"}),c.requiresTransformation===!1&&e.jsx(ne,{variant:"secondary",className:"text-xs",children:"Pass-through"}),c.functionNode&&e.jsx(ne,{variant:c.functionNode.functionName==="nodeMapping"?"secondary":"default",className:"text-xs",children:c.functionNode.functionName==="nodeMapping"?`Node: ${c.functionNode.parameters?.sourceType||"object"} → ${c.functionNode.parameters?.targetType||"object"}`:`Function: ${c.functionNode.functionName}`})]}),e.jsxs("div",{className:"flex gap-1",children:[c.requiresTransformation!==!1&&e.jsx(e.Fragment,{children:e.jsx(O,{variant:"ghost",size:"sm",onClick:()=>{u.info(m.UI,"🔥 Lightning bolt clicked for mapping",{data:c.id}),S(c.id)},className:"h-6 w-6 p-0 hover-scale",title:"Open Visual Flow Editor",children:e.jsx(qe,{className:"h-3 w-3"})})}),e.jsx(O,{variant:"ghost",size:"sm",onClick:()=>a(c.id),className:"h-6 w-6 p-0 text-destructive hover:text-destructive hover-scale",title:"Remove Mapping",children:e.jsx(ce,{className:"h-3 w-3"})})]})]}),e.jsxs("div",{className:"text-xs space-y-1",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("span",{className:"font-medium text-primary",children:c.name})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium",children:"Source:"}),e.jsx("span",{className:"text-muted-foreground",children:c.sourceFields?c.sourceFields.join(", "):""})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(tt,{className:"h-3 w-3 text-primary"}),e.jsx("span",{className:"font-medium",children:"Target:"}),e.jsx("span",{className:"text-muted-foreground",children:c.targetField})]}),c.requiresTransformation!==!1&&e.jsxs(e.Fragment,{children:[c.functionNode&&e.jsxs("div",{className:"mt-2 p-2 bg-primary/10 rounded text-xs",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx(qe,{className:"h-3 w-3 text-primary"}),e.jsx("span",{className:"font-medium text-primary",children:"Function Mapping:"})]}),e.jsx("div",{className:"text-muted-foreground",children:c.functionNode.functionName==="visual_flow"?c.visualFlowData?`Visual Flow - ${c.sourceFields?c.sourceFields.length:0} source field(s): ${c.sourceFields?c.sourceFields.join(", "):""}`:`Visual Flow - ${c.sourceFields?c.sourceFields.length:0} source field(s) connected`:`${c.functionNode.functionName} with ${Object.keys(c.functionNode.sourceConnections).length} parameter(s) connected`})]}),!c.functionNode&&e.jsx("div",{className:"mt-2 text-xs text-muted-foreground italic",children:"Click the lightning icon to configure transformations using the visual flow editor"})]}),c.requiresTransformation===!1&&e.jsx("div",{className:"mt-2 text-xs text-muted-foreground italic",children:"Direct field mapping - no transformation required"})]})]},c.id))})}),l.open&&l.targetField&&e.jsx(la,{open:l.open,onClose:()=>p({open:!1,selectedFunction:"",targetField:null,filteredSourceFields:[]}),selectedFunction:l.selectedFunction,sourceFields:l.filteredSourceFields||s,targetField:l.targetField,onApplyMapping:C}),x.open&&x.targetField&&e.jsx(Na,{open:x.open,onClose:()=>j({open:!1,targetField:null}),sourceFields:s,targetField:x.targetField,onApplyMapping:N,initialMapping:x.existingMapping})]})}function wa({open:t,onOpenChange:s,mappings:n,mappingName:a,mappingType:r,sourceXml:o="",targetXml:l=""}){const{toast:p}=lt(),[x,j]=g.useState(""),[S,N]=g.useState(""),[C,c]=g.useState("idle"),[f,b]=g.useState(""),[i,F]=g.useState(!1),T=D=>{const _=D.target.files?.[0];if(_){const J=new FileReader;J.onload=A=>{const d=A.target?.result;j(d)},J.readAsText(_)}},h=async()=>{if(!x.trim()){p({title:"Input Required",description:"Please provide input XML to test the mapping",variant:"destructive"});return}F(!0),c("testing"),b(""),N("");try{const D=await dt.post("/test/field-mappings",{inputXml:x,mappings:n.map(_=>({sourceFields:_.sourceFields,targetField:_.targetField,sourcePaths:_.sourcePaths,targetPath:_.targetPath,javaFunction:_.functionNode?.functionName==="visual_flow"?"visual_flow":_.javaFunction,functionNode:_.functionNode,visualFlowData:_.visualFlowData,requiresTransformation:_.requiresTransformation!==!1})),mappingType:r,sourceStructureXml:o,targetStructureXml:l});if(D.data.success)N(D.data.outputXml),c("success"),p({title:"Test Successful",description:"Field mappings were applied successfully"});else throw new Error(D.data.error||"Test failed")}catch(D){c("error");const _=D.response?.data?.message||D.message||"Failed to test mappings";b(_),p({title:"Test Failed",description:_,variant:"destructive"})}finally{F(!1)}},y=()=>{navigator.clipboard.writeText(S),p({title:"Copied",description:"Output XML copied to clipboard"})},E=()=>{const D=new Blob([S],{type:"text/xml"}),_=URL.createObjectURL(D),J=document.createElement("a");J.href=_,J.download=`${a}_${r}_output.xml`,document.body.appendChild(J),J.click(),document.body.removeChild(J),URL.revokeObjectURL(_)},P=()=>{j(`<?xml version="1.0" encoding="UTF-8"?>
<${r==="request"?"Request":r==="response"?"Response":"Fault"}>
 <!-- Add your test data here -->
 <Token>sample-token-123</Token>
 <amount>100.00</amount>
 <subClass>A</subClass>
 <tariffIndex>1</tariffIndex>
 <meterBaseDate>2024-01-01</meterBaseDate>
 <keyExpiryNumber>12345</keyExpiryNumber>
 <supplyGroupCode>SG001</supplyGroupCode>
 <keyRevisionNumber>1</keyRevisionNumber>
 <meterSerialNumber>MSN123456</meterSerialNumber>
 <encryptionAlgorithm>AES256</encryptionAlgorithm>
</${r==="request"?"Request":r==="response"?"Response":"Fault"}>`)};return e.jsx(pe,{open:t,onOpenChange:s,children:e.jsxs(he,{className:"max-w-6xl max-h-[90vh] overflow-hidden flex flex-col",children:[e.jsxs(xe,{children:[e.jsxs(ge,{children:["Test Field Mappings - ",a]}),e.jsxs($t,{children:["Test your ",r," field mappings with sample XML data. Upload or paste your input XML to see the transformation results."]})]}),e.jsx("div",{className:"flex-1 overflow-hidden",children:e.jsxs(pt,{defaultValue:"test",className:"h-full flex flex-col",children:[e.jsxs(ht,{children:[e.jsx(ze,{value:"test",children:"Test Mappings"}),e.jsxs(ze,{value:"mappings",children:["View Mappings (",n.length,")"]})]}),e.jsxs(Be,{value:"test",className:"flex-1 overflow-auto mt-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4 h-full",children:[e.jsxs(Ie,{children:[e.jsxs(Re,{children:[e.jsx(Ae,{children:"Input XML"}),e.jsx(Ge,{children:"Provide the source XML to test the mappings"})]}),e.jsxs(Le,{className:"space-y-4",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsx(O,{variant:"outline",size:"sm",onClick:P,children:"Load Sample"}),e.jsx(ae,{htmlFor:"file-upload",className:"cursor-pointer",children:e.jsx(O,{variant:"outline",size:"sm",asChild:!0,children:e.jsxs("span",{children:[e.jsx(Bt,{className:"h-4 w-4 mr-2"}),"Upload XML"]})})}),e.jsx("input",{id:"file-upload",type:"file",accept:".xml",onChange:T,className:"hidden"})]}),e.jsx(Ve,{value:x,onChange:D=>j(D.target.value),placeholder:"Paste your input XML here...",className:"font-mono text-sm h-[400px]"})]})]}),e.jsxs(Ie,{children:[e.jsxs(Re,{children:[e.jsx(Ae,{children:"Output XML"}),e.jsx(Ge,{children:"Transformed XML after applying field mappings"})]}),e.jsxs(Le,{className:"space-y-4",children:[C==="success"&&e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(O,{variant:"outline",size:"sm",onClick:y,children:[e.jsx(Wt,{className:"h-4 w-4 mr-2"}),"Copy"]}),e.jsxs(O,{variant:"outline",size:"sm",onClick:E,children:[e.jsx(Yt,{className:"h-4 w-4 mr-2"}),"Download"]})]}),C==="idle"&&e.jsxs(Te,{children:[e.jsx(at,{className:"h-4 w-4"}),e.jsx(Ee,{children:'Click "Test Mapping" to see the transformation results'})]}),C==="testing"&&e.jsx("div",{className:"flex items-center justify-center h-[400px]",children:e.jsx(De,{className:"h-8 w-8 animate-spin text-primary"})}),C==="error"&&e.jsxs(Te,{variant:"destructive",children:[e.jsx(at,{className:"h-4 w-4"}),e.jsx(Ee,{children:f})]}),C==="success"&&e.jsx(Ve,{value:S,readOnly:!0,className:"font-mono text-sm h-[400px]"})]})]})]}),e.jsx("div",{className:"flex justify-center mt-6",children:e.jsx(O,{onClick:h,disabled:i||!x.trim(),size:"lg",children:i?e.jsxs(e.Fragment,{children:[e.jsx(De,{className:"h-4 w-4 mr-2 animate-spin"}),"Testing..."]}):e.jsxs(e.Fragment,{children:[e.jsx(xt,{className:"h-4 w-4 mr-2"}),"Test Mapping"]})})})]}),e.jsx(Be,{value:"mappings",className:"flex-1 overflow-auto mt-4",children:e.jsx("div",{className:"space-y-4",children:n.map((D,_)=>e.jsxs(Ie,{children:[e.jsx(Re,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(Ae,{className:"text-sm",children:D.name}),e.jsxs(ne,{variant:"outline",children:["Mapping ",_+1]})]})}),e.jsxs(Le,{className:"space-y-2",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx(ae,{className:"text-muted-foreground",children:"Source Fields"}),e.jsx("p",{className:"font-mono",children:D.sourceFields.join(", ")})]}),e.jsxs("div",{children:[e.jsx(ae,{className:"text-muted-foreground",children:"Target Field"}),e.jsx("p",{className:"font-mono",children:D.targetField})]})]}),D.functionNode&&e.jsxs("div",{children:[e.jsx(ae,{className:"text-muted-foreground",children:"Transformation"}),e.jsx("p",{className:"font-mono text-sm",children:D.functionNode.functionName})]})]})]},D.id))})})]})})]})})}async function Ca(t,s){try{const n=await dt.post(`/structures/${t}/convert-to-xml`,s||{});return u.info(m.SYSTEM,"Received XML conversion result",{structureId:n.data?.structureId,structureName:n.data?.structureName,xmlContent:n.data?.xmlContent}),n.data}catch(n){throw u.error(m.ERROR,"XML conversion error for structure",{structureId:t,error:n.response?.data}),n}}function _e(t){const n=new DOMParser().parseFromString(t,"text/xml");u.info(m.SYSTEM,"Parsing XML content",{data:t});const a=n.querySelector("parsererror");if(a){const l=t.split(`
`);if(u.error(m.ERROR,"XML parsing error",{errorText:a.textContent,lineCount:l.length,problematicLines:l.map((p,x)=>({lineNumber:x+1,content:p,length:p.length})).filter(p=>p.lineNumber>=15&&p.lineNumber<=25)}),u.error(m.ERROR,"Full line 17",{error:l[16]}),u.error(m.ERROR,"Full line 18",{error:l[17]}),l[17]){u.error(m.ERROR,"Line 18 character analysis around column 14:");for(let p=10;p<20&&p<l[17].length;p++)u.error(m.ERROR,"Error occurred",{error:` Position ${p}: '${l[17][p]}' (char code: ${l[17].charCodeAt(p)})`})}throw new Error("Invalid XML: "+a.textContent)}const r=n.documentElement;return[{id:`${r.tagName}_root`,name:r.tagName,type:"object",path:r.tagName,expanded:!0,children:We(r,r.tagName)}]}function We(t,s=""){const n=[];if(t.attributes.length>0)for(let o=0;o<t.attributes.length;o++){const l=t.attributes[o];if(!l.name.startsWith("xmlns")){const p=s?`${s}.@${l.name}`:`@${l.name}`;n.push({id:`${p}_attr_${o}`,name:`@${l.name}`,type:"attribute",path:p,expanded:!1})}}const a=new Set,r=new Map;for(let o=0;o<t.children.length;o++){const l=t.children[o],p=l.tagName;r.has(p)||r.set(p,[]),r.get(p).push(l)}u.info(m.SYSTEM,"Processing children in order for node",{data:t.tagName});for(let o=0;o<t.children.length;o++){const p=t.children[o].tagName;if(u.info(m.SYSTEM,`Child ${o}: ${p}`),a.has(p))continue;a.add(p);const x=r.get(p);if(x.length===1){const j=x[0],S=s?`${s}.${p}`:p,N=j.children.length>0||j.attributes.length>0,C={id:`${S}_${Date.now()}_${Math.random()}`,name:p,type:N?"object":"string",path:S,expanded:!1,children:N?We(j,S):void 0};n.push(C)}else{const j=s?`${s}.${p}[]`:`${p}[]`,S={id:`${j}_array_${Date.now()}`,name:`${p}[]`,type:"array",path:j,expanded:!1,children:x[0].children.length>0||x[0].attributes.length>0?We(x[0],`${j}[0]`):void 0};n.push(S)}}if(t.textContent&&t.children.length===0&&n.length===0){const o=s?`${s}._text`:"_text";n.push({id:`${o}_text`,name:"_text",type:"string",path:o,expanded:!1})}return n}function Va({onClose:t,onSave:s,initialMappingName:n="",initialMappings:a=[],sampleStructures:r=[],inboundAdapterType:o="",outboundAdapterType:l="",sourceXml:p="",targetXml:x="",preConverted:j=!1,mappingType:S="request"}){const[N,C]=g.useState([]),[c,f]=g.useState([]),[b,i]=g.useState(a),[F,T]=g.useState(null),[h,y]=g.useState(""),[E,P]=g.useState(""),[D,_]=g.useState(""),[J,A]=g.useState(""),[d,v]=g.useState(!1),[q,L]=g.useState(!1),[M,G]=g.useState(n),[R,$]=g.useState(!1),[se,ue]=g.useState(!1),[W,fe]=g.useState(null),[B,Ue]=g.useState(null),[jt,Ze]=g.useState(!1),{structures:ye}=ut(),{toast:re}=lt(),Ke=(w,k)=>{try{const X=new DOMParser().parseFromString(w,"text/xml").documentElement,I=document.implementation.createDocument(null,X.tagName,null),Y=I.documentElement;for(let H=0;H<X.attributes.length;H++){const z=X.attributes[H];Y.setAttribute(z.name,z.value)}const Z={request:["_Req_","Request","Input","input"],response:["_Resp_","Response","Output","output"],fault:["Fault","fault","Error","error","Exception"]}[k];for(let H=0;H<X.children.length;H++){const z=X.children[H],te=z.tagName;if(Z.some(K=>te.includes(K)||te.toLowerCase().includes(K.toLowerCase()))){const K=I.importNode(z,!0);Y.appendChild(K)}}if(Y.children.length===0)return u.warn(m.UI,`No matching elements found for ${k} mapping, returning original XML`),w;if(Y.children.length===1){const H=X.tagName.toLowerCase();if(H==="sourcemessage"||H==="targetmessage"||H==="message"||H==="root"){const z=Y.children[0],te=document.implementation.createDocument(null,z.tagName,null),ve=te.importNode(z,!0);return te.replaceChild(ve,te.documentElement),new XMLSerializer().serializeToString(te)}}return new XMLSerializer().serializeToString(I)}catch(U){return u.error(m.UI,"Error filtering XML by message type",{error:U}),w}};g.useEffect(()=>{if(j&&p&&x)try{const w=Ke(p,S),k=Ke(x,S),U=_e(w),V=_e(k);C(U),f(V),_(`Pre-converted XML (${S})`),A(`Pre-converted XML (${S})`),u.info(m.UI,`Filtering XML for ${S} mapping`,{originalSource:p,filteredSource:w,originalTarget:x,filteredTarget:k})}catch(w){u.error(m.UI,"Error parsing pre-converted XML",{error:w}),re({title:"XML Parse Error",description:w.message||"Failed to parse XML structures",variant:"destructive"})}else j||(async()=>{if(o&&l&&ye.length>0&&!D&&!J){const k=ye.filter(V=>V.usage==="source"||!V.usage),U=ye.filter(V=>V.usage==="target"||!V.usage);k.length>0&&await $e(k[0].name,!0),U.length>0&&await $e(U[0].name,!1)}})()},[j,p,x,o,l,ye,S]);const Qe=g.useCallback((w,k)=>{const U=V=>V.map(X=>X.id===w?{...X,expanded:!X.expanded}:X.children?{...X,children:U(X.children)}:X);k?C(U):f(U)},[]),vt=w=>{T(w)},Nt=()=>{T(null)},bt=w=>{w.preventDefault()},wt=w=>{if(!F)return;const k=F.type==="array"||F.type==="object",U=w.type==="array"||w.type==="object",V=k&&U,X=b.findIndex(I=>I.targetPath===w.path);if(X>=0){const I=b[X],Y={...I,sourceFields:[...I.sourceFields,F.name],sourcePaths:[...I.sourcePaths,F.path]},ee=[...b];ee[X]=Y,i(ee)}else{const I={id:`mapping_${Date.now()}`,name:`${F.name}_to_${w.name}`,sourceFields:[F.name],targetField:w.name,sourcePaths:[F.path],targetPath:w.path,...V&&{javaFunction:"nodeMapping",functionNode:{id:`node_${Date.now()}`,functionName:"nodeMapping",parameters:{sourceType:F.type,targetType:w.type,isArrayMapping:F.type==="array"||w.type==="array"?"true":"false"},sourceConnections:{},position:{x:0,y:0}}}};i(Y=>[...Y,I]),V&&re({title:"Node Mapping Created",description:`Created ${F.type} to ${w.type} mapping. This will map all child fields.`})}T(null)},Ct=w=>{i(k=>k.filter(U=>U.id!==w))},St=()=>{i([])},Me=w=>w.name.replace(/\[\]$/,"").split(".").pop()||w.name,je=(w,k=[])=>(w.forEach(U=>{k.push(U),U.children&&je(U.children,k)}),k),Ft=()=>{if(!N.length||!c.length){re({title:"Cannot auto-map",description:"Please select both source and target structures first",variant:"destructive"});return}const w=[],k=new Set(b.map(I=>I.targetPath));if(W&&B){const I=(W.type==="array"||W.type==="object")&&W.children&&W.children.length>0,Y=(B.type==="array"||B.type==="object")&&B.children&&B.children.length>0;if(I&&Y){let ee=0;if(!k.has(B.path)){const z={id:`mapping_${Date.now()}_${Math.random()}`,name:`${W.name}_to_${B.name}`,sourceFields:[W.name],targetField:B.name,sourcePaths:[W.path],targetPath:B.path,javaFunction:"nodeMapping",functionNode:{id:`node_${Date.now()}_${Math.random()}`,functionName:"nodeMapping",parameters:{sourceType:W.type,targetType:B.type,isArrayMapping:W.type==="array"||B.type==="array"?"true":"false"},sourceConnections:{},position:{x:0,y:0}}};w.push(z),k.add(B.path),ee++}const Z=je(W.children||[]),oe=je(B.children||[]),H=new Map;oe.forEach(z=>{const te=Me(z);H.has(te)||H.set(te,[]),H.get(te).push(z)}),Z.forEach(z=>{const te=Me(z),ve=H.get(te)||[],K=ve.find(me=>!k.has(me.path)&&me.type===z.type)||ve.find(me=>!k.has(me.path));if(K){const me=(z.type==="array"||z.type==="object")&&(K.type==="array"||K.type==="object"),Et={id:`mapping_${Date.now()}_${Math.random()}`,name:`${z.name}_to_${K.name}`,sourceFields:[z.name],targetField:K.name,sourcePaths:[z.path],targetPath:K.path,...me&&{javaFunction:"nodeMapping",functionNode:{id:`node_${Date.now()}_${Math.random()}`,functionName:"nodeMapping",parameters:{sourceType:z.type,targetType:K.type,isArrayMapping:z.type==="array"||K.type==="array"?"true":"false"},sourceConnections:{},position:{x:0,y:0}}}};w.push(Et),k.add(K.path),ee++}}),ee>0?(i(z=>[...z,...w]),re({title:"Node mapping complete",description:`Created ${ee} mappings for matching fields within selected nodes`})):re({title:"No matching fields found",description:"Could not find any matching field names within the selected nodes",variant:"destructive"}),fe(null),Ue(null)}else if(k.has(B.path))re({title:"Target already mapped",description:"The selected target field is already mapped",variant:"destructive"});else{const ee={id:`mapping_${Date.now()}_${Math.random()}`,name:`${W.name}_to_${B.name}`,sourceFields:[W.name],targetField:B.name,sourcePaths:[W.path],targetPath:B.path};i(Z=>[...Z,ee]),re({title:"Mapping created",description:`Mapped ${W.name} to ${B.name}`}),fe(null),Ue(null)}return}const U=je(N),V=je(c),X=new Map;V.forEach(I=>{const Y=Me(I);X.has(Y)||X.set(Y,[]),X.get(Y).push(I)}),U.forEach(I=>{const Y=Me(I),ee=X.get(Y)||[],Z=ee.find(oe=>!k.has(oe.path)&&oe.type===I.type)||ee.find(oe=>!k.has(oe.path));if(Z){const oe=(I.type==="array"||I.type==="object")&&(Z.type==="array"||Z.type==="object"),H={id:`mapping_${Date.now()}_${Math.random()}`,name:`${I.name}_to_${Z.name}`,sourceFields:[I.name],targetField:Z.name,sourcePaths:[I.path],targetPath:Z.path,...oe&&{javaFunction:"nodeMapping",functionNode:{id:`node_${Date.now()}_${Math.random()}`,functionName:"nodeMapping",parameters:{sourceType:I.type,targetType:Z.type,isArrayMapping:I.type==="array"||Z.type==="array"?"true":"false"},sourceConnections:{},position:{x:0,y:0}}}};w.push(H),k.add(Z.path)}}),w.length>0?(i(I=>[...I,...w]),re({title:"Auto-mapping complete",description:`Created ${w.length} automatic mappings`})):re({title:"No matching fields found",description:"Could not find any matching field names between source and target",variant:"destructive"})},$e=async(w,k)=>{const U=ye.find(V=>V.name===w);if(!(!U||!U.id))try{k?$(!0):ue(!0);const X=(await Ca(U.id,{rootElementName:U.name.replace(/\s+/g,""),includeXmlDeclaration:!0,prettyPrint:!0,convertPropertyNames:!0,preserveNullValues:!1})).xmlContent;let I;try{I=_e(X)}catch(Y){throw u.error(m.UI,"Error parsing XML",{error:Y}),u.error(m.UI,"XML content that failed to parse",{error:X}),Y}k?(_(w),C(I),v(!1)):(A(w),f(I),L(!1)),re({title:"Structure converted to XML",description:`${w} has been converted to XML format for mapping`})}catch(V){u.error(m.UI,"Error converting structure to XML",{error:V}),re({title:"Conversion failed",description:V.message||"Failed to convert structure to XML",variant:"destructive"})}finally{k?$(!1):ue(!1)}},Dt=(w,k)=>{i(U=>U.map(V=>V.id===w?{...V,...k}:V))},Tt=w=>{i(k=>[...k,w])};return e.jsxs("div",{className:"fixed inset-0 bg-background z-50 overflow-hidden animate-fade-in",children:[e.jsx("div",{className:"border-b",children:e.jsxs("div",{className:"h-16 flex items-center justify-between px-6",children:[e.jsx("div",{className:"flex items-center gap-4",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ae,{htmlFor:"mappingName",className:"text-sm font-medium",children:"Mapping Name:"}),e.jsx(ie,{id:"mappingName",placeholder:"Enter mapping name",value:M,onChange:w=>G(w.target.value),className:"w-64"})]})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(O,{variant:"outline",onClick:Ft,className:"hover-scale",disabled:!N.length||!c.length,children:[e.jsx(qe,{className:"h-4 w-4 mr-2"}),W&&B?"Map Selected":"Map All"]}),e.jsxs(O,{variant:"outline",onClick:St,className:"text-destructive hover:text-destructive hover-scale",children:[e.jsx(Ht,{className:"h-4 w-4 mr-2"}),"Delete All Mappings"]}),b.length>0&&e.jsxs(e.Fragment,{children:[e.jsxs(O,{variant:"outline",onClick:()=>Ze(!0),className:"hover-scale",children:[e.jsx(xt,{className:"h-4 w-4 mr-2"}),"Test Mapping"]}),e.jsxs(O,{onClick:()=>s?.(b,M),className:"hover-scale",disabled:!M.trim(),children:[e.jsx(kt,{className:"h-4 w-4 mr-2"}),"Save Mappings"]})]}),e.jsxs(O,{variant:"outline",onClick:t,className:"hover-scale",children:[e.jsx(ce,{className:"h-4 w-4 mr-2"}),"Close"]})]})]})}),e.jsxs("div",{className:"flex h-[calc(100vh-8rem)]",children:[e.jsx(ea,{fields:N,mappings:b,selectedService:D,searchValue:h,showSelector:!j&&d,selectedField:W,onSearchChange:y,onShowSelectorChange:v,onSelectService:w=>$e(w,!0),onToggleExpanded:Qe,onDragStart:vt,onDragEnd:Nt,onSelectField:fe,isLoading:R,hideSelector:j}),e.jsx(ba,{mappings:b,sourceFields:N,targetFields:c,onRemoveMapping:Ct,onUpdateMapping:Dt,onCreateMapping:Tt}),e.jsx(ta,{fields:c,mappings:b,selectedService:J,searchValue:E,showSelector:!j&&q,selectedField:B,onSearchChange:P,onShowSelectorChange:L,onSelectService:w=>$e(w,!1),onToggleExpanded:Qe,onDragOver:bt,onDrop:wt,onSelectField:Ue,isLoading:se,hideSelector:j})]}),e.jsx(wa,{open:jt,onOpenChange:Ze,mappings:b,mappingName:M,mappingType:S,sourceXml:p,targetXml:x})]})}export{Va as F,Jt as G,Zt as H,Qt as T,Ca as c};
